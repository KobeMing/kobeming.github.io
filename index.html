<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="baidu-site-verification" content="L6Lm9d5Crl"/>
  
  
  
  
  <title>Ming</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Ming blogs">
<meta property="og:type" content="website">
<meta property="og:title" content="Ming">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Ming">
<meta property="og:description" content="Ming blogs">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ming">
<meta name="twitter:description" content="Ming blogs">
  
    <link rel="alternative" href="/atom.xml" title="Ming" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
    
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/avatar.jpg" class="js-avatar">
            
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Pu Ming</a></h1>
        </hgroup>
        
        <p class="header-subtitle">ming</p>
        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder="搜索一下" autocomplete="off">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0) 
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';                
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                } 
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        
        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a  href="/archives/">所有文章</a></li>
                        
                            <li><a  href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github"  target="_blank" href="/xxxxx" title="github">github</a>
                            
                                <a class="fl weibo"  target="_blank" href="/xxxxxxxx" title="weibo">weibo</a>
                            
                                <a class="fl rss"  target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        
                    </div>
                </section>
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank"  class="main-nav-link switch-friends-link" href="http://my.csdn.net/my/mycsdn">csdn</a>
                    
                      <a target="_blank"  class="main-nav-link switch-friends-link" href="http://www.jianshu.com/u/343e9f257182">简书</a>
                    
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">puming</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Pu Ming</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/avatar.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Pu Ming</a></h1>
            </hgroup>
            
            <p class="header-subtitle">ming</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="/xxxxx" title="github">github</a>
                    
                        <a class="weibo" target="_blank" href="/xxxxxxxx" title="weibo">weibo</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-Android加载ReactNative页面流程" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2017/12/04/Android加载ReactNative页面流程/" class="article-date">
      <time datetime="2017-12-04T12:37:44.000Z" itemprop="datePublished">2017-12-04</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2017/12/04/Android加载ReactNative页面流程/">Android加载ReactNative页面流程</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="ReactNative页面加载过程"><a href="#ReactNative页面加载过程" class="headerlink" title="ReactNative页面加载过程"></a>ReactNative页面加载过程</h1><p>Android加载ReactNative页面分为两条逻辑，第一：加载index.android.bundle 第二：加载drwable-mdpi目录下的图片。</p>
<h2 id="加载index-android-bundle的过程"><a href="#加载index-android-bundle的过程" class="headerlink" title="加载index.android.bundle的过程"></a>加载index.android.bundle的过程</h2><p>Android加载index.android.bundle途径有三种：</p>
<ol>
<li>从node服务器远程调用（debug调试，也就是Debug JS Remotely开关打开）</li>
<li>应用程序assets目录 </li>
<li>本地文件（包括内部存储，外部存储）</li>
</ol>
<blockquote>
<p>注意：开发阶段，reload时是先从node服务器把ReactNativeDevBundle.js文件缓存到内部存储（dada/data/包名/files/ReactNativeDevBundle.js），然后从内部存储加载。</p>
</blockquote>
<p>相关源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//com.facebook.react.devsupport.DevSupportManagerImpl.java</div><div class="line"> //...</div><div class="line">   private static final String JS_BUNDLE_FILE_NAME = &quot;ReactNativeDevBundle.js&quot;;</div><div class="line"> //...</div><div class="line"> // TODO(6418010): Fix readers-writers problem in debug reload from HTTP server</div><div class="line">    mJSBundleTempFile = new File(applicationContext.getFilesDir(), JS_BUNDLE_FILE_NAME);</div></pre></td></tr></table></figure>
<p>三种方式的加载其实只是bundle文件来源的path不同，最终都是由JSBundleLoader完成加载。下面把整个加载过程分为bundle文件path赋值过程和JSBundleLoader执行加载两部分进行分析。</p>
<h4 id="JSBundleLoader执行加载过程："><a href="#JSBundleLoader执行加载过程：" class="headerlink" title="JSBundleLoader执行加载过程："></a>JSBundleLoader执行加载过程：</h4><p>整个JSBundleLoader源码非常简单，创建了4个加载器：</p>
<ul>
<li>createAssetLoader<blockquote>
<p>加载assets目录下的bundle</p>
</blockquote>
</li>
<li>createFileLoader<blockquote>
<p>加载本地文件的bundle</p>
</blockquote>
</li>
<li>createCachedBundleFromNetworkLoader<blockquote>
<p>加载data/data/package-name/filses/ReactNativeDevBundle.js</p>
</blockquote>
</li>
<li>createRemoteDebuggerBundleLoader<blockquote>
<p>加载本地node服务器的bundle</p>
</blockquote>
</li>
</ul>
<p>真正完成加载功能是在CatalystInstanceImpl中，用JNI实现。源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">private native void jniSetSourceURL(String sourceURL);</div><div class="line"></div><div class="line">private native void jniLoadScriptFromAssets(AssetManager assetManager, String assetURL, boolean loadSynchronously);</div><div class="line"></div><div class="line">private native void jniLoadScriptFromFile(String fileName, String sourceURL, boolean loadSynchronously);</div></pre></td></tr></table></figure>
<h4 id="bundle文件path赋值过程："><a href="#bundle文件path赋值过程：" class="headerlink" title="bundle文件path赋值过程："></a>bundle文件path赋值过程：</h4><p>我们在Application中实现或重写的ReactNativeHost相关方法就是初始化赋值，其中：</p>
<ul>
<li>getJSMainModuleName</li>
<li>getJSBundleFile</li>
<li>getBundleAssetName</li>
</ul>
<p>最终都会传递到ReactInstanceManagerBuilder中，源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">protected ReactInstanceManager createReactInstanceManager() &#123;</div><div class="line">    ReactInstanceManagerBuilder builder = ReactInstanceManager.builder()</div><div class="line">      .setApplication(mApplication)</div><div class="line">      .setJSMainModuleName(getJSMainModuleName())</div><div class="line">      .setUseDeveloperSupport(getUseDeveloperSupport())</div><div class="line">      .setRedBoxHandler(getRedBoxHandler())</div><div class="line">      .setUIImplementationProvider(getUIImplementationProvider())</div><div class="line">      .setInitialLifecycleState(LifecycleState.BEFORE_CREATE);</div><div class="line"></div><div class="line">    for (ReactPackage reactPackage : getPackages()) &#123;</div><div class="line">      builder.addPackage(reactPackage);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String jsBundleFile = getJSBundleFile();</div><div class="line">    if (jsBundleFile != null) &#123;</div><div class="line">      builder.setJSBundleFile(jsBundleFile);</div><div class="line">    &#125; else &#123;</div><div class="line">      builder.setBundleAssetName(Assertions.assertNotNull(getBundleAssetName()));</div><div class="line">    &#125;</div><div class="line">    return builder.build();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>从源码中可以看出，首先从本地文件加载bundle文件，如果本地文件不存在bundle文件从assets目录加载。</p>
<p>然后ReactInstanceManagerBuilder构建ReactInstanceManager时把JSBundleLoader传递给ReactInstanceManager，源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">new ReactInstanceManager(</div><div class="line">      mApplication,</div><div class="line">      mCurrentActivity,</div><div class="line">      mDefaultHardwareBackBtnHandler,</div><div class="line">      (mJSBundleLoader == null &amp;&amp; mJSBundleAssetUrl != null) ?</div><div class="line">        JSBundleLoader.createAssetLoader(mApplication, mJSBundleAssetUrl, false /*Asynchronous*/) :</div><div class="line">        mJSBundleLoader,</div><div class="line">      mJSMainModuleName,</div><div class="line">      mPackages,</div><div class="line">      mUseDeveloperSupport,</div><div class="line">      mBridgeIdleDebugListener,</div><div class="line">      Assertions.assertNotNull(mInitialLifecycleState, &quot;Initial lifecycle state was not set&quot;),</div><div class="line">      mUIImplementationProvider,</div><div class="line">      mNativeModuleCallExceptionHandler,</div><div class="line">      mJSCConfig,</div><div class="line">      mRedBoxHandler,</div><div class="line">      mLazyNativeModulesEnabled,</div><div class="line">      mLazyViewManagersEnabled,</div><div class="line">      mSetupReactContextInBackground,</div><div class="line">      mUseSeparateUIBackgroundThread,</div><div class="line">      mMinNumShakes);</div></pre></td></tr></table></figure>
<p>在构建ReactInstanceManager过程中，首先判断JSBundleLoader是否为空，如果为空，调用JSBundleLoader内部方法创建对应的加载器（上文介绍的4个加载器）。如果不为空直接传递给ReactInstanceManager。</p>
<p>以上JSBundleLoader只能加载本地文件或assets目录的bundle文件，那么远程bundle和缓存中的ReactNativeDevBundle.js的加载器是直接在ReactInstanceManager内部创建的，源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@ThreadConfined(UI)</div><div class="line">private void onReloadWithJSDebugger(JavaJSExecutor.Factory jsExecutorFactory) &#123;</div><div class="line">  Log.d(ReactConstants.TAG, &quot;ReactInstanceManager.onReloadWithJSDebugger()&quot;);</div><div class="line">  recreateReactContextInBackground(</div><div class="line">      new ProxyJavaScriptExecutor.Factory(jsExecutorFactory),</div><div class="line">      //创建远程加载bundle文件的加载器（debug调试）</div><div class="line">      JSBundleLoader.createRemoteDebuggerBundleLoader(</div><div class="line">          mDevSupportManager.getJSBundleURLForRemoteDebugging(),</div><div class="line">          mDevSupportManager.getSourceUrl()));</div><div class="line">&#125;</div><div class="line"></div><div class="line">@ThreadConfined(UI)</div><div class="line">private void onJSBundleLoadedFromServer() &#123;</div><div class="line">  Log.d(ReactConstants.TAG, &quot;ReactInstanceManager.onJSBundleLoadedFromServer()&quot;);</div><div class="line">  recreateReactContextInBackground(</div><div class="line">      mJavaScriptExecutorFactory,</div><div class="line">      //创建加载缓存目录ReactNativeDevBundle.js的加载器</div><div class="line">      JSBundleLoader.createCachedBundleFromNetworkLoader(</div><div class="line">          mDevSupportManager.getSourceUrl(), mDevSupportManager.getDownloadedJSBundleFile()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="一张图总结："><a href="#一张图总结：" class="headerlink" title="一张图总结："></a>一张图总结：</h4><p><img src="http://upload-images.jianshu.io/upload_images/5684685-885050fe85cbb356.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p>
<h2 id="图片加载过程"><a href="#图片加载过程" class="headerlink" title="图片加载过程"></a>图片加载过程</h2><h4 id="ReactNative加载图片的几种方式"><a href="#ReactNative加载图片的几种方式" class="headerlink" title="ReactNative加载图片的几种方式"></a>ReactNative加载图片的几种方式</h4><h6 id="1-通过uri加载图片"><a href="#1-通过uri加载图片" class="headerlink" title="1.通过uri加载图片"></a>1.通过uri加载图片</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> source=&#123;&#123;uri: &quot;file://&quot; + path&#125;&#125;/&gt;</div><div class="line"> //或</div><div class="line">source=&#123;&#123;uri: &quot;http://&quot; + location&#125;&#125;/&gt;</div></pre></td></tr></table></figure>
<h6 id="2-加载本地图片"><a href="#2-加载本地图片" class="headerlink" title="2.加载本地图片"></a>2.加载本地图片</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;Image source=&#123;require(&quot;../../images/mode.png&quot;)&#125;/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>最终加载的是被打包到drawable-mdpi下的图片，形如：images_mode.png</p>
</blockquote>
<h6 id="3-加载Native端资源图片"><a href="#3-加载Native端资源图片" class="headerlink" title="3.加载Native端资源图片"></a>3.加载Native端资源图片</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//导入 nativeImageSource函数</div><div class="line">let nativeImageSource = require(&apos;nativeImageSource&apos;);</div><div class="line"></div><div class="line"> let spec = &#123;</div><div class="line">        android: &apos;mipmap/ic_launcher&apos;,</div><div class="line">        width: 72,</div><div class="line">        height: 72</div><div class="line">      &#125;;</div><div class="line">      </div><div class="line">&lt;Image source=&#123;nativeImageSource(spec)&#125;/&gt;</div></pre></td></tr></table></figure>
<p>以上几种加载图片的方式只是为Image组件的source属性赋值不同，最终都是resolveAssetSource.js中实现。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * `source` is either a number (opaque type returned by require(&apos;./foo.png&apos;))</div><div class="line"> * or an `ImageSource` like &#123; uri: &apos;&lt;http location || file path&gt;&apos; &#125;</div><div class="line"> */</div><div class="line">function resolveAssetSource(source: any): ?ResolvedAssetSource &#123;</div><div class="line">  if (typeof source === &apos;object&apos;) &#123;</div><div class="line">    return source;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  var asset = AssetRegistry.getAssetByID(source);</div><div class="line">  if (!asset) &#123;</div><div class="line">    return null;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  const resolver = new AssetSourceResolver(getDevServerURL(), getBundleSourcePath(), asset);</div><div class="line">  if (_customSourceTransformer) &#123;</div><div class="line">    return _customSourceTransformer(resolver);</div><div class="line">  &#125;</div><div class="line">  return resolver.defaultAsset();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上三种加载图片的方式中，<strong>通过uri加载图片</strong>和<strong>加载Native端资源图片</strong>赋值给source的值其实就是object。从源码可以看出，如果通过这两种方式加载图片直接就把这个对象返回了。</p>
<p>后面的处理逻辑都是在处理通过<strong>加载本地图片</strong>的方式的流程，具体实现在AssetSourceResolver.js中。如果应用有热更新需求，那么热更新图片就只需要处理这种加载方式的问题。建议有热更新功能的应用尽量都把图片放在服务器，然后通过第一种方式加载。</p>
<h4 id="本地图片加载过程"><a href="#本地图片加载过程" class="headerlink" title="本地图片加载过程"></a>本地图片加载过程</h4><p>本地图片加载其实就是加载的被打包到drawable-mdpi中的图片，实现源码如下：</p>
<blockquote>
<p>node_modules / react-native / Libraries / Image /AssetSourceResolver.js</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">defaultAsset(): ResolvedAssetSource &#123;  </div><div class="line">  if (this.isLoadedFromServer()) &#123;  </div><div class="line">    return this.assetServerURL();  </div><div class="line">  &#125;  </div><div class="line">  </div><div class="line">  if (Platform.OS === &apos;android&apos;) &#123;  </div><div class="line">    return this.isLoadedFromFileSystem() ?  </div><div class="line">      this.drawableFolderInBundle() :  </div><div class="line">      this.resourceIdentifierWithoutScale();  </div><div class="line">  &#125; else &#123;  </div><div class="line">    return this.scaledAssetPathInBundle();  </div><div class="line">  &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>drawableFolderInBundle方法为在存在离线bundle文件时，从bundle文件所在目录加载图片。</p>
<p>resourceIdentifierWithoutScale方法从asset资源目录下加载。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-Android-Multidex原理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2017/11/12/Android-Multidex原理/" class="article-date">
      <time datetime="2017-11-12T12:37:44.000Z" itemprop="datePublished">2017-11-12</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2017/11/12/Android-Multidex原理/">Android Multidex原理</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Java中ClassLoader加载机制"><a href="#Java中ClassLoader加载机制" class="headerlink" title="Java中ClassLoader加载机制"></a>Java中ClassLoader加载机制</h1><h2 id="Java中常见类加载器"><a href="#Java中常见类加载器" class="headerlink" title="Java中常见类加载器"></a>Java中常见类加载器</h2><ul>
<li>AppClassLoader</li>
</ul>
<p>Java类的全名是sun.misc.Launcher$AppClassLoader，主要加载工程目录CLASSPATH，AppDemo/bin路径下的包</p>
<ul>
<li>ExtClassLoader（AppClassLoader的parent）</li>
</ul>
<p>Java类的全名是sun.misc.Launcher$ExtClassLoader，主要加载jre/lib/ext/目录下的扩展包</p>
<ul>
<li>BootstrapClassLoader（需要通过反射获取）</li>
</ul>
<p>纯C++实现的类加载器，没有对应的Java类，主要加载jre/lib/目录下的核心库。</p>
<p>此目录下的rt.jar中的ArrayList.getClassLoader()打印出来之后是null，因为没有对应的Java类。</p>
<p><strong>测试代码如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">public class Client &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        //Client父亲加载器</div><div class="line">        Class clientClass = Client.class;</div><div class="line">        ClassLoader clientLoader = clientClass.getClassLoader();</div><div class="line">        System.out.println(&quot;cientLoader.toString() = &quot; + clientLoader.toString());</div><div class="line">        // sun.misc.Launcher$AppClassLoader</div><div class="line"></div><div class="line">        //AppClassLoader加载路径</div><div class="line">        URLClassLoader urlClassLoader = (URLClassLoader) clientLoader;</div><div class="line">        URL[] urLs = urlClassLoader.getURLs();</div><div class="line">        pri(urLs);</div><div class="line">        // url = file:/E:/AndroidStudioProjects/RX/JavaModule/build/classes/java/main/</div><div class="line"></div><div class="line">        //AppClassLoader父加载器</div><div class="line">        ClassLoader parent = clientLoader.getParent();</div><div class="line">        System.out.println(&quot;parent = &quot; + parent);</div><div class="line">        //sun.misc.Launcher$ExtClassLoader@75b84c92</div><div class="line"></div><div class="line">        //ExtClassLoader加载路径</div><div class="line">        URL[] urLs2 = ((URLClassLoader) parent).getURLs();</div><div class="line">        pri(urLs2);</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/access-bridge-64.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/cldrdata.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/dnsns.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/jaccess.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/localedata.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/nashorn.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/sunec.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/sunjce_provider.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/sunmscapi.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/sunpkcs11.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/ext/zipfs.jar</div><div class="line">        </div><div class="line">        //ExtClassLoader无父加载器</div><div class="line">        </div><div class="line">        //BootstrapClassLoader c++实现</div><div class="line">        ClassLoader parentParent = parent.getParent();</div><div class="line">        System.out.println(&quot;parentParent = &quot; + parentParent);</div><div class="line">        //BootstrapClassLoader加载路径</div><div class="line">        try &#123;</div><div class="line">            Class launcherClass = Class.forName(&quot;sun.misc.Launcher&quot;);</div><div class="line">            Method getBootstrapClassPath = launcherClass.getDeclaredMethod(&quot;getBootstrapClassPath&quot;,null);</div><div class="line">            Object obj = getBootstrapClassPath.invoke(null, null);</div><div class="line">            if(obj!=null)&#123;</div><div class="line">                Method getUrls = obj.getClass().getDeclaredMethod(&quot;getURLs&quot;, null);</div><div class="line">                if (getUrls != null) &#123;</div><div class="line">                    getUrls.setAccessible(true);</div><div class="line">                    URL[] urls = (URL[]) getUrls.invoke(obj, null);</div><div class="line">                    pri(urls);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; catch (ClassNotFoundException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; catch (NoSuchMethodException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; catch (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; catch (InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/resources.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/rt.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/sunrsasign.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/jsse.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/jce.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/charsets.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/lib/jfr.jar</div><div class="line">//        url = file:/D:/Android%20Studio/jre/jre/classes</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void pri(URL[] urls) &#123;</div><div class="line">        for (URL url : urls) &#123;</div><div class="line">            System.out.println(&quot;url = &quot; + url);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="父委托机制"><a href="#父委托机制" class="headerlink" title="父委托机制"></a>父委托机制</h2><ul>
<li><strong>加载一个类的流程图</strong></li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/5684685-04a3800bded0e7e6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p>
<blockquote>
<p>这里类加载器之间的父子关系不是继承关系而是组合关系。也就是说父加载器指的是委托机制中的父级别，并非父类。</p>
</blockquote>
<ul>
<li><p>优点</p>
<blockquote>
<p>能够提高软件系统的安全性。如果建立了一个包名 + 类名完全一样的ArrayList，Java虚拟器仍然会加载到JDK中的jre/lib/rt.jar里面的ArrayList，从而不会被用户轻易修改。这是因为同一个类，如果他们被不同的类加载器加载，那么被加载的这些类不“想等”。这里所指的“相等”，包括代表类的Class对象的equals()方法，isAssignabFrom方法isInstance()方法的返回结果，也包括使用instanceof关键字做对象所属关系的判定。由于这个原因，使用父委托机制才保证了软件系统安全性。</p>
</blockquote>
</li>
<li><p>ClassLoader对应源码</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">protected Class&lt;?&gt; loadClass(String var1, boolean var2) throws ClassNotFoundException &#123;</div><div class="line">        synchronized(this.getClassLoadingLock(var1)) &#123;</div><div class="line">            Class var4 = this.findLoadedClass(var1);</div><div class="line">            if(var4 == null) &#123;</div><div class="line">                long var5 = System.nanoTime();</div><div class="line"></div><div class="line">                //parent也是ClassLoader类型</div><div class="line">                try &#123;</div><div class="line">                    if(this.parent != null) &#123;</div><div class="line">                        var4 = this.parent.loadClass(var1, false);</div><div class="line">                    &#125; else &#123;</div><div class="line">                        //调用Native方法</div><div class="line">                        var4 = this.findBootstrapClassOrNull(var1);</div><div class="line">                    &#125;</div><div class="line">                &#125; catch (ClassNotFoundException var10) &#123;</div><div class="line">                    ;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if(var4 == null) &#123;</div><div class="line">                    long var7 = System.nanoTime();</div><div class="line">                    var4 = this.findClass(var1);</div><div class="line">                    PerfCounter.getParentDelegationTime().addTime(var7 - var5);</div><div class="line">                    PerfCounter.getFindClassTime().addElapsedTimeFrom(var7);</div><div class="line">                    PerfCounter.getFindClasses().increment();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if(var2) &#123;</div><div class="line">                this.resolveClass(var4);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            return var4;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="Android中类加载器介绍"><a href="#Android中类加载器介绍" class="headerlink" title="Android中类加载器介绍"></a>Android中类加载器介绍</h2><ul>
<li>PathClassLoader</li>
</ul>
<p>加载/data/app目录下的apk文件，从这个目录看看看出，PathClassLoader主要用来加载已经安装好了的apk</p>
<ul>
<li>DexClassLoader</li>
</ul>
<p>加载路径需要在创建DexClassLoader时传入，也就是说可以加载任何路径下的apk/dex/jar</p>
<ul>
<li><p>BaseClassLoader</p>
</li>
<li><p>DexPathList<br>操作dex文件的对象,findClass()查找dex列表中的Class,Element[]存放dex文件的数组</p>
</li>
</ul>
<h4 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h4><p><img src="http://upload-images.jianshu.io/upload_images/5684685-c60fae2d79cbd775.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p>
<h1 id="Gradle分包"><a href="#Gradle分包" class="headerlink" title="Gradle分包"></a>Gradle分包</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    defaultConfig &#123;</div><div class="line">        ...</div><div class="line">        minSdkVersion 15 </div><div class="line">        targetSdkVersion 26</div><div class="line">        multiDexEnabled true</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">  compile &apos;com.android.support:multidex:1.0.1&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    package=&quot;com.example&quot;&gt;</div><div class="line">    &lt;application</div><div class="line">            android:name=&quot;android.support.multidex.MultiDexApplication&quot; &gt;</div><div class="line">        ...</div><div class="line">    &lt;/application&gt;</div><div class="line">&lt;/manifest&gt;</div></pre></td></tr></table></figure>
<h1 id="动态加载Dex"><a href="#动态加载Dex" class="headerlink" title="动态加载Dex"></a>动态加载Dex</h1><p>普通App的类加载过程:<br>PathClassLoader委托给BootClassLoder</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">graph LR</div><div class="line">PathClassLoader--&gt;BootClassLoder</div></pre></td></tr></table></figure>
<h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h2><p>将DexClassLoader插入到PathClassLoader和BootClassLoader中间</p>
<p><img src="http://upload-images.jianshu.io/upload_images/5684685-9542d85cb106a1f2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">public class MyApplication extends Application &#123;</div><div class="line">    @Override</div><div class="line">    public void onCreate() &#123;</div><div class="line">        super.onCreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void attachBaseContext(Context base) &#123;</div><div class="line">        super.attachBaseContext(base);</div><div class="line">        loadeDex();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 动态加载dex</div><div class="line">     */</div><div class="line">    private void loadeDex() &#123;</div><div class="line">        File dexDir = new File(this.getFilesDir(), &quot;dex&quot;);</div><div class="line">        if (dexDir != null &amp;&amp; !dexDir.exists()) &#123;</div><div class="line">            dexDir.mkdir();</div><div class="line">        &#125;</div><div class="line">        File odexDir = new File(this.getFilesDir(), &quot;odex&quot;);</div><div class="line">        if (odexDir != null &amp;&amp; !odexDir.exists()) &#123;</div><div class="line">            odexDir.mkdir();</div><div class="line">        &#125;</div><div class="line">        //拷贝assets目录下的libs.apk到dexDir目录。</div><div class="line">        File dexFile = new File(dexDir, &quot;libs.apk&quot;);</div><div class="line">        int len = -1;</div><div class="line">        byte[] buf = new byte[2048];</div><div class="line">        InputStream is = null;</div><div class="line">        FileOutputStream fos = null;</div><div class="line">        try &#123;</div><div class="line">            is = this.getAssets().open(&quot;libs.apk&quot;);</div><div class="line">            if (is != null) &#123;</div><div class="line">                fos = new FileOutputStream(dexFile);</div><div class="line">                while ((len = is.read(buf)) != -1) &#123;</div><div class="line">                    fos.write(buf, 0, len);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if (fos != null) &#123;</div><div class="line">                fos.close();</div><div class="line">            &#125;</div><div class="line">            if (is != null) &#123;</div><div class="line">                is.close();</div><div class="line">            &#125;</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        //将DexClassLoader插入到PathClassLoader和BootClassLoader中间</div><div class="line">        ClassLoader classLoader = getClassLoader();</div><div class="line">        DexClassLoader dexClassLoader = new DexClassLoader(dexFile.getAbsolutePath(), odexDir.getAbsolutePath(),</div><div class="line">                getSoPath(), classLoader.getParent());</div><div class="line">        try &#123;</div><div class="line">            Field parent = ClassLoader.class.getDeclaredField(&quot;parent&quot;);</div><div class="line">            if (parent != null) &#123;</div><div class="line">                parent.setAccessible(true);</div><div class="line">                parent.set(classLoader,dexClassLoader);</div><div class="line">            &#125;</div><div class="line">        &#125; catch (NoSuchFieldException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; catch (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private String getSoPath() &#123;</div><div class="line">        ApplicationInfo info = getApplicationInfo();</div><div class="line">        if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.FROYO) &#123;</div><div class="line">            return info.nativeLibraryDir;</div><div class="line">        &#125; else &#123;</div><div class="line">            return &quot;data/data&quot; + info.packageName + &quot;lib&quot;;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h2><p>把DexClassLoader中的Element数组追加到PathClassLoader加载路径中</p>
<blockquote>
<p>com.android.support:multidex:1.0.1就是这种实现方式</p>
</blockquote>
<p><img src="http://upload-images.jianshu.io/upload_images/5684685-9802565baf02e7a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p>
<h4 id="MultiDex关键代码"><a href="#MultiDex关键代码" class="headerlink" title="MultiDex关键代码"></a>MultiDex关键代码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 将DexClassLoader的Element[]追加到PathClassLoader中</div><div class="line"> */</div><div class="line">private static void install(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries, File optimizedDirectory) throws IllegalArgumentException, IllegalAccessException, NoSuchFieldException, InvocationTargetException, NoSuchMethodException &#123;</div><div class="line">    </div><div class="line"> /* The patched class loader is expected to be a descendant of</div><div class="line">    * dalvik.system.BaseDexClassLoader. We modify its</div><div class="line">    * dalvik.system.DexPathList pathList field to append additional DEX</div><div class="line">    * file entries.</div><div class="line">    */</div><div class="line">    Field pathListField = MultiDex.findField(loader, &quot;pathList&quot;);</div><div class="line">    Object dexPathList = pathListField.get(loader);</div><div class="line">    ArrayList suppressedExceptions = new ArrayList();</div><div class="line">    MultiDex.expandFieldArray(dexPathList, &quot;dexElements&quot;, makeDexElements(dexPathList, new ArrayList(additionalClassPathEntries), optimizedDirectory, suppressedExceptions));</div><div class="line"></div><div class="line">    // ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 数组复制过程</div><div class="line"> */</div><div class="line">private static void expandFieldArray(Object instance, String fieldName, Object[] extraElements) throws NoSuchFieldException, IllegalArgumentException, IllegalAccessException &#123;</div><div class="line">    Field jlrField = findField(instance, fieldName);</div><div class="line">    Object[] original = (Object[])((Object[])jlrField.get(instance));</div><div class="line">    Object[] combined = (Object[])((Object[])Array.newInstance(original.getClass().getComponentType(), original.length + extraElements.length));</div><div class="line">    System.arraycopy(original, 0, combined, 0, original.length);</div><div class="line">    System.arraycopy(extraElements, 0, combined, original.length, extraElements.length);</div><div class="line">    jlrField.set(instance, combined);</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-结构性模式-代理模式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2017/11/11/结构性模式-代理模式/" class="article-date">
      <time datetime="2017-11-11T12:37:44.000Z" itemprop="datePublished">2017-11-11</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2017/11/11/结构性模式-代理模式/">结构性模式-代理模式</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>最近研究ReactNative,发现ReactNative在跨越平台性和热更新方面的确有一定优势，但是性能依旧差原生太多。所以就学习了滴滴开源的插件化库<a href="https://github.com/didi/VirtualAPK/" target="_blank" rel="external">VirtualAPK</a>。学习中发现<a href="https://github.com/didi/VirtualAPK/" target="_blank" rel="external">VirtualAPK</a>库中使用了动态代理，因此需要先巩固一下代理模式的基础知识。以此篇文章作为学习笔记。</p>
<h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><p>为其他对象提供一种代理以控制对这个对象的访问。在某些情况下，一个对象不适合或者不能直接引用另一个对象，而代理对象可以在客户端和目标对象之间起到中介的作用。</p>
<h1 id="类图"><a href="#类图" class="headerlink" title="类图"></a>类图</h1><p><img src="http://upload-images.jianshu.io/upload_images/5684685-b618faa0551f5471.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p>
<h1 id="类图说明"><a href="#类图说明" class="headerlink" title="类图说明"></a>类图说明</h1><ul>
<li>Subject:<blockquote>
<p>该类的主要职责是声明目标类与代理类的共同接口方法，该类既可以是抽象类也可以是接口。</p>
</blockquote>
</li>
<li>RealSubject:<blockquote>
<p>该类被称为目标类或者被代理类。该类定义了代理所表示的真实对象，由 其执行具体的业务逻辑方法，而客户类则通过代理类间接的调用目标类中的方法。</p>
</blockquote>
</li>
<li><p>ProxySubject</p>
<blockquote>
<p>该类被称为代理类。该类持有一个目标类的引用，在其所实现的接口方法中调用目标类的相应接口方法，以此达到代理作用。一个代理对象可以代理多个实现了抽象主题的目标对象。</p>
</blockquote>
</li>
<li><p>Client：</p>
</li>
</ul>
<p>客户端调用案例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public class Client &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        RealSubject target = new RealSubject();</div><div class="line">        ProxySubject proxy = new ProxySubject(target);</div><div class="line">        proxy.method1();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="代理模式分类"><a href="#代理模式分类" class="headerlink" title="代理模式分类"></a>代理模式分类</h1><h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><p>静态代理指的是代理对象的代码是已经生成好了的固定代码，然后对其代码进行编译。也就是说在代码运行前代理类的class文件已经存在。</p>
<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>动态代理指的是通过反射机制动态的生成代理者的对象，不存在代理类的字节码文件。代理类和委托类的关系是在程序运行时确定。 而Java也给我们提供了便捷的动态代理API。</p>
<h4 id="Java-API"><a href="#Java-API" class="headerlink" title="Java API"></a>Java API</h4><ul>
<li>java.lang.reflect.Proxy</li>
<li>java.lang.reflect.InvocationHandler</li>
</ul>
<p>下面是滴滴VirtualAPK框架动态代理部分代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">public class IContentProviderProxy implements InvocationHandler &#123;</div><div class="line"></div><div class="line">    private IContentProvider mBase;//被代理的类引用</div><div class="line">    private Context mContext;</div><div class="line"></div><div class="line">    private IContentProviderProxy(Context context, IContentProvider iContentProvider) &#123;</div><div class="line">        mBase = iContentProvider;</div><div class="line">        mContext = context;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //动态构造一个代理者</div><div class="line">    public static IContentProvider newInstance(Context context, IContentProvider iContentProvider) &#123;</div><div class="line">        return (IContentProvider) Proxy.newProxyInstance(iContentProvider.getClass().getClassLoader(),</div><div class="line">                new Class[] &#123; IContentProvider.class &#125;, new IContentProviderProxy(context, iContentProvider));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</div><div class="line">        //在这个方法中调用具体被代理的方法</div><div class="line">        wrapperUri(method, args);</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            return method.invoke(mBase, args);</div><div class="line">        &#125; catch (InvocationTargetException e) &#123;</div><div class="line">            throw e.getTargetException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-ReactNavigation" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2017/11/02/ReactNavigation/" class="article-date">
      <time datetime="2017-11-02T08:37:44.000Z" itemprop="datePublished">2017-11-02</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2017/11/02/ReactNavigation/">ReactNavigation</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="StackNavigator"><a href="#StackNavigator" class="headerlink" title="StackNavigator"></a>StackNavigator</h1><p>StackNavigator用来解决屏幕跳转，用它的效果页面导航效果|类似于栈，新启动的页面覆盖在原先的页面上。</p>
<h4 id="函数原型："><a href="#函数原型：" class="headerlink" title="函数原型："></a>函数原型：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">export default (</div><div class="line">  routeConfigMap: NavigationRouteConfigMap,</div><div class="line">  stackConfig: StackNavigatorConfig = &#123;&#125;</div><div class="line">) =&gt; &#123;//...&#125;</div></pre></td></tr></table></figure>
<p>这个函数接受2个对象作为参数，routeConfigMap和stackConfig，其中routeConfigMap配置路由参数，定义组件的导航状态，后文的TabNavigator，DrawerNavigator的这个参数也都一样。stackConfig可以省略，如果省略，则默认选择routeConfigMap中定义的第一个路由。</p>
<h4 id="定义属性的相关源码："><a href="#定义属性的相关源码：" class="headerlink" title="定义属性的相关源码："></a>定义属性的相关源码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">//StackNavigatorConfig的属性</div><div class="line">export type NavigationStackRouterConfig = &#123;</div><div class="line">  initialRouteName?: string,</div><div class="line">  initialRouteParams?: NavigationParams,</div><div class="line">  paths?: NavigationPathsConfig,</div><div class="line">  navigationOptions?: NavigationScreenConfig&lt;NavigationStackScreenOptions&gt;,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">export type NavigationStackViewConfig = &#123;</div><div class="line">  mode?: &apos;card&apos; | &apos;modal&apos;,</div><div class="line">  headerMode?: HeaderMode,</div><div class="line">  cardStyle?: Style,</div><div class="line">  transitionConfig?: () =&gt; TransitionConfig,</div><div class="line">  onTransitionStart?: () =&gt; void,</div><div class="line">  onTransitionEnd?: () =&gt; void,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//navigationOptions的属性</div><div class="line">export type NavigationScreenOptions = &#123;</div><div class="line">  title?: string,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">export type NavigationStackScreenOptions = NavigationScreenOptions &amp; &#123;</div><div class="line">  header?: ?(React.Element&lt;*&gt; | (HeaderProps =&gt; React.Element&lt;*&gt;)),</div><div class="line">  headerTitle?: string | React.Element&lt;*&gt;,</div><div class="line">  headerTitleStyle?: Style,</div><div class="line">  headerTintColor?: string,</div><div class="line">  headerLeft?: React.Element&lt;*&gt;,</div><div class="line">  headerBackTitle?: string,</div><div class="line">  headerTruncatedBackTitle?: string,</div><div class="line">  headerBackTitleStyle?: Style,</div><div class="line">  headerPressColorAndroid?: string,</div><div class="line">  headerRight?: React.Element&lt;*&gt;,</div><div class="line">  headerStyle?: Style,</div><div class="line">  gesturesEnabled?: boolean,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="属性总结"><a href="#属性总结" class="headerlink" title="属性总结:"></a>属性总结:</h4><ul>
<li>initialRouteName：<blockquote>
<p>设置初始化路由名称</p>
</blockquote>
</li>
<li>initialRouteParams：<blockquote>
<p>设置初始化路由的参数</p>
</blockquote>
</li>
<li>paths：<blockquote>
<p>map结构，覆盖在路由配置中的path</p>
</blockquote>
</li>
<li>headerMode：<blockquote>
<p>指定如何渲染头部，可以设置为float,screen,none。如果设置为none,则不会有头部；如果设置为float, 页面跳转时，header是一直在顶部，而且如果header变化了的话，会有动画，有点像android的共享动画；设置成screen的话，头部是跟随这新的页面重新出现。</p>
</blockquote>
</li>
<li>mode：<blockquote>
<p>定义渲染的和跳转动画的风格，可以设置为card,modal。默认为card。modal可以使界面跳转的而动画是从底部逐渐显示到整个屏幕，这个只对ios有效，因为android,默认转场动画就是从底部逐渐显示到真个屏幕</p>
</blockquote>
</li>
<li>cardStyle：<blockquote>
<p>可以给页面设置style</p>
</blockquote>
</li>
<li>transitionConfig：<blockquote>
<p>函数类型，可以用来配置转厂动画</p>
</blockquote>
</li>
<li>onTransitionStart：<blockquote>
<p>函数类型，动画开始后的回调</p>
</blockquote>
</li>
<li>onTransitionEnd：<blockquote>
<p>函数类型，动画结束时的回调</p>
</blockquote>
</li>
<li>navigationOptions：<blockquote>
<p>屏幕导航参数，每个屏幕都可以配置。这个属性的value是一个对象，下面介绍navigationOptions的属性。</p>
</blockquote>
</li>
</ul>
<h5 id="navigationOptions属性"><a href="#navigationOptions属性" class="headerlink" title="navigationOptions属性"></a>navigationOptions属性</h5><ul>
<li>title:<blockquote>
<p>string类型，如果设置了它，如果headerTitle或tabBarBabel没有设置的话，将默认会使用这个值</p>
</blockquote>
</li>
<li>header：<blockquote>
<p>React Eelement或 是一个参数是HeaderProps返回Rect Element类型的函数类型。它用来显示为header,设置null的话，可以隐藏header</p>
</blockquote>
</li>
<li>headerTitle：<blockquote>
<p>string 或者 React Element类型，用来设置header,默认显示的 title</p>
</blockquote>
</li>
<li>headerTitleStyle：<blockquote>
<p>用来设置title组件的样式</p>
</blockquote>
</li>
<li>headerTintColor：<blockquote>
<p>用来设置header的颜色</p>
</blockquote>
</li>
<li>headerLeft：<blockquote>
<p>React Element类型，用来在Header左边添加控件</p>
</blockquote>
</li>
<li>headerBackTitle：<blockquote>
<p>string 类型，用来设置在ios上显示黑色按钮，设置null不显示，默认是title</p>
</blockquote>
</li>
<li>headerTruncatedBackTitle：<blockquote>
<p>string 类型， 用来设置黑色按钮，当headerBackTitle没有充满屏幕的时候。</p>
</blockquote>
</li>
<li>headerBackTitleStyle：<blockquote>
<p>用来设置黑色Title的样式</p>
</blockquote>
</li>
<li>headerPressColorAndroid：<blockquote>
<p>用来设置涟漪效果的颜色，android&gt;5.0有效</p>
</blockquote>
</li>
<li>headerRight：<blockquote>
<p>React Element类型，用来在Header右边添加控件</p>
</blockquote>
</li>
<li>headerStyle：<blockquote>
<p>设置header的样式</p>
</blockquote>
</li>
<li>gesturesEnabled：<blockquote>
<p>开启的话，你可以用手势 关闭页面，ios默认是true,Android默认是false。</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>navigationOptions也可以在具体的某一屏设置,但是在routeConfigMap中设置的有优先级较高。如下：</td>
<td></td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">class Detail extends Component &#123;</div><div class="line">  static navigationOptions = &#123;</div><div class="line">    title: &apos;详情页&apos;,</div><div class="line">  &#125;;</div><div class="line">  render() &#123;</div><div class="line">    return null;</div><div class="line">  &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h4 id="使用例子："><a href="#使用例子：" class="headerlink" title="使用例子："></a>使用例子：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">const NavigationRouteConfigMap = &#123;</div><div class="line">  Tabs: &#123;</div><div class="line">    //Tabs可以是一个React组件，也可以是TabNavigator，DrawerNavigator。它将成为屏幕的主要内容。</div><div class="line">    //当StackNavigator加载Tabs时，它将会被赋予一个“navigation”属性。</div><div class="line">    screen: Tabs,</div><div class="line">    //这是一个可选属性</div><div class="line">    path: &apos;&apos;,</div><div class="line">    //这是一个可选属性，如果配置会覆盖屏幕 static navigationOptions的设置</div><div class="line">    navigationOptions: &#123;</div><div class="line">      title: &quot;导航&quot;,</div><div class="line">      header: null,</div><div class="line">      cardStack: &#123;</div><div class="line">        gesturesEnabled: false,</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  Detail: &#123;</div><div class="line">    screen: Detail,</div><div class="line">  &#125;,</div><div class="line">  VideoView: &#123;screen: VideoView&#125;,</div><div class="line">&#125;;</div><div class="line">const StackNavigatorConfig = &#123;</div><div class="line">  navigationOptions: &#123;</div><div class="line">    headerTitle: &quot;全局配置&quot;,</div><div class="line">    headerBackTitle: null,</div><div class="line">    headerTintColor: &apos;&apos;,</div><div class="line">    showIcon: true</div><div class="line">  &#125;,</div><div class="line">  modal: &apos;card&apos;,</div><div class="line">  headerMode: &apos;screen&apos;,</div><div class="line">  transitionConfig: () =&gt; (&#123;</div><div class="line">    screenInterpolator: CardStackStyleInterpolator.forHorizontal,</div><div class="line">  &#125;)</div><div class="line">&#125;;</div><div class="line">const AppNavigator = StackNavigator(NavigationRouteConfigMap,StackNavigatorConfig);</div></pre></td></tr></table></figure>
<h1 id="TabNavigator"><a href="#TabNavigator" class="headerlink" title="TabNavigator"></a>TabNavigator</h1><p>用这个可以实现几个屏幕之间相互切换，（类似于android原生，TabLayout+Fragment 页面切换那种效果）。</p>
<h4 id="函数原型"><a href="#函数原型" class="headerlink" title="函数原型:"></a>函数原型:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">const TabNavigator = (</div><div class="line">  routeConfigs: NavigationRouteConfigMap,</div><div class="line">  config: TabNavigatorConfig = &#123;&#125;</div><div class="line">) =&gt; &#123;//...&#125;</div></pre></td></tr></table></figure>
<p>同样，这个函数接受2个对象作为参数，routeConfigMap和config，其中routeConfigMap与StackNavigator中一样。</p>
<h4 id="定义属性的相关源码：-1"><a href="#定义属性的相关源码：-1" class="headerlink" title="定义属性的相关源码："></a>定义属性的相关源码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">//TabNavigatorConfig的所有属性</div><div class="line">export type NavigationTabRouterConfig = &#123;</div><div class="line">  initialRouteName?: string,</div><div class="line">  paths?: NavigationPathsConfig,</div><div class="line">  navigationOptions?: NavigationScreenConfig&lt;NavigationTabScreenOptions&gt;,</div><div class="line">  order?: Array&lt;string&gt;, // todo: type these as the real route names rather than &apos;string&apos;</div><div class="line">  // Does the back button cause the router to switch to the initial tab</div><div class="line">  backBehavior?: &apos;none&apos; | &apos;initialRoute&apos;, // defaults `initialRoute`</div><div class="line">&#125;;</div><div class="line"></div><div class="line">export type TabViewConfig = &#123;</div><div class="line">  tabBarComponent?: ReactClass&lt;*&gt;,</div><div class="line">  tabBarPosition?: &apos;top&apos; | &apos;bottom&apos;,</div><div class="line">  tabBarOptions?: &#123;&#125;,</div><div class="line">  swipeEnabled?: boolean,</div><div class="line">  animationEnabled?: boolean,</div><div class="line">  lazy?: boolean,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//navigationOptions的属性</div><div class="line">export type NavigationScreenOptions = &#123;</div><div class="line">  title?: string,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">export type NavigationTabScreenOptions = NavigationScreenOptions &amp; &#123;</div><div class="line">  tabBarIcon?:</div><div class="line">    | React.Element&lt;*&gt;</div><div class="line">    | ((options: &#123; tintColor: ?string, focused: boolean &#125;) =&gt; ?React.Element&lt;</div><div class="line">      *</div><div class="line">    &gt;),</div><div class="line">  tabBarLabel?:</div><div class="line">    | string</div><div class="line">    | React.Element&lt;*&gt;</div><div class="line">    | ((options: &#123; tintColor: ?string, focused: boolean &#125;) =&gt; ?React.Element&lt;</div><div class="line">      *</div><div class="line">    &gt;),</div><div class="line">  tabBarVisible?: boolean,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//tabBarOptions的属性</div><div class="line">//TabBarTop.js tabBarPosition的值为top时的属性</div><div class="line">type Props = &#123;</div><div class="line">  activeTintColor: string,</div><div class="line">  inactiveTintColor: string,</div><div class="line">  showIcon: boolean,</div><div class="line">  showLabel: boolean,</div><div class="line">  upperCaseLabel: boolean,</div><div class="line">  position: Animated.Value,</div><div class="line">  navigation: NavigationScreenProp&lt;NavigationState, NavigationAction&gt;,</div><div class="line">  getLabel: (scene: TabScene) =&gt; ?(React.Element&lt;*&gt; | string),</div><div class="line">  renderIcon: (scene: TabScene) =&gt; React.Element&lt;*&gt;,</div><div class="line">  labelStyle?: Style,</div><div class="line">  iconStyle?: Style,</div><div class="line">&#125;;</div><div class="line">//TabBarBottom.js tabBarPosition的值为bottom时的属性</div><div class="line">type Props = &#123;</div><div class="line">  activeTintColor: string,</div><div class="line">  activeBackgroundColor: string,</div><div class="line">  inactiveTintColor: string,</div><div class="line">  inactiveBackgroundColor: string,</div><div class="line">  position: Animated.Value,</div><div class="line">  navigation: NavigationScreenProp&lt;NavigationState, NavigationAction&gt;,</div><div class="line">  jumpToIndex: (index: number) =&gt; void,</div><div class="line">  getLabel: (scene: TabScene) =&gt; ?(React.Element&lt;*&gt; | string),</div><div class="line">  renderIcon: (scene: TabScene) =&gt; React.Element&lt;*&gt;,</div><div class="line">  showLabel: boolean,</div><div class="line">  style?: Style,</div><div class="line">  labelStyle?: Style,</div><div class="line">  showIcon: boolean,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="属性总结："><a href="#属性总结：" class="headerlink" title="属性总结："></a>属性总结：</h4><ul>
<li>initialRouteName:<blockquote>
<p>初始化路由的名称</p>
</blockquote>
</li>
<li>paths:<blockquote>
<p>提供一个map,可以路由对应的path</p>
</blockquote>
</li>
<li>navigationOptions: <blockquote>
<p>与StackNavigator中一样，他的value是一个对象，后文介绍其属性</p>
</blockquote>
</li>
<li>order:<blockquote>
<p>路由名称数组</p>
</blockquote>
</li>
<li>backBehavior:<blockquote>
<p>如果设置为true,那么this.props.navigation.goBack()’不会起作用</p>
</blockquote>
</li>
<li>tabBarComponent:<blockquote>
<p>用来设置tabBar的组件，ios默认是TabBarBottom，android默认是TabBarTop</p>
</blockquote>
</li>
<li>tabBarPosition:<blockquote>
<p>用来设置tabBar的位置，可以为 ‘top’ 或者’bottom’</p>
</blockquote>
</li>
<li>tabBarOptions:<blockquote>
<p>用来设置tabBar的一些属性，颜色、样式等等，后文介绍tabBarOptions的属性</p>
</blockquote>
</li>
<li>swipeEnabled:<blockquote>
<p>用来设置是否可以滑动切换</p>
</blockquote>
</li>
<li>animationEnabled:<blockquote>
<p>用来设置是否有动画效果</p>
</blockquote>
</li>
<li>lazy:<blockquote>
<p>用来设置是否“懒渲染”tabBar</p>
</blockquote>
</li>
</ul>
<p><strong>tabBarOptions属性</strong></p>
<ul>
<li>activeTintColor<blockquote>
<p>激活的tab的tint 颜色，tint颜色值，icon和Label的颜色</p>
</blockquote>
</li>
<li>activeBackgroundColor<blockquote>
<p>激活tab的背景颜色</p>
</blockquote>
</li>
<li>inactiveTintColor<blockquote>
<p>没被激活的tint颜色</p>
</blockquote>
</li>
<li>inactiveBackgroundColor<blockquote>
<p>没被激活的tab的背景色</p>
</blockquote>
</li>
<li>showLabel<blockquote>
<p>是否显示label，默认是true</p>
</blockquote>
</li>
<li>showIcon<blockquote>
<p>是否显示icon,默认是false</p>
</blockquote>
</li>
<li>upperCaseLabel<blockquote>
<p>是否开启大写转换，默认是true</p>
</blockquote>
</li>
<li>pressColor<blockquote>
<p>按压颜色，涟漪效果，andorid&gt;5.0有效</p>
</blockquote>
</li>
<li>pressOpacity<blockquote>
<p>压颜色，透明度变换，android&lt;5.0 和ios可用。</p>
</blockquote>
</li>
<li>scrollEnabled<blockquote>
<p>tabs是够可以滑动</p>
</blockquote>
</li>
<li>style</li>
<li>tabStyle</li>
<li>labelStyle</li>
<li>iconStyle</li>
<li>indicatorStyle<blockquote>
<p>底部指示器的样式</p>
</blockquote>
</li>
</ul>
<p><strong>navigationOptions属性</strong></p>
<ul>
<li>title<blockquote>
<p>标题，如果headerTitle,和tabBarLabel,不设置的话，就默认是title</p>
</blockquote>
</li>
<li>tabBarVisible<blockquote>
<p>决定隐藏还是显示tabBar</p>
</blockquote>
</li>
<li>tabBarIcon<blockquote>
<p>可以是一个React Eclement，或者是一个参数为{focused:boolean,tintColor:string}返回Rect Element的函数，用来显示在Tab Bar上</p>
</blockquote>
</li>
<li>tabBarLabel<blockquote>
<p>string类型，或者React Element类型，或者是参数为{focused:boolean,tintColor:string}返回React Element的函数</p>
</blockquote>
</li>
</ul>
<h4 id="使用例子：-1"><a href="#使用例子：-1" class="headerlink" title="使用例子："></a>使用例子：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">const NavigationRouteConfigMap = &#123;</div><div class="line">  Home: &#123;</div><div class="line">    screen: Home,</div><div class="line">    navigationOptions: &#123;</div><div class="line">      tabBarLabel: &apos;首页&apos;,</div><div class="line">      tabBarIcon: (&#123;tintColor&#125;) =&gt;</div><div class="line">        &lt;Image</div><div class="line">          style=&#123;[styles.tabBarImage, /*&#123;tintColor: tintColor&#125;*/]&#125;</div><div class="line">          source=&#123;require(&apos;../images/mode.png&apos;)&#125;</div><div class="line">        /&gt;,</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  Find: &#123;</div><div class="line">    screen: Find,</div><div class="line">    navigationOptions: &#123;</div><div class="line">      tabBarLabel: &apos;发现&apos;,</div><div class="line">      tabBarIcon: (&#123;tintColor&#125;) =&gt;</div><div class="line">        &lt;Image</div><div class="line">          style=&#123;[styles.tabBarImage,]&#125;</div><div class="line">          source=&#123;require(&apos;../images/mode.png&apos;)&#125;</div><div class="line">        /&gt;,</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  Message: &#123;</div><div class="line">    screen: Message,</div><div class="line">    navigationOptions: &#123;</div><div class="line">      tabBarLabel: &apos;消息&apos;,</div><div class="line">      tabBarIcon: (&#123;tintColor&#125;) =&gt;</div><div class="line">        &lt;Image</div><div class="line">          style=&#123;[styles.tabBarImage,]&#125;</div><div class="line">          source=&#123;require(&apos;../images/mode.png&apos;)&#125;</div><div class="line">        /&gt;,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  Me: &#123;</div><div class="line">    screen: Me,</div><div class="line">    navigationOptions: &#123;</div><div class="line">      title: &quot;hello&quot;,</div><div class="line">      tabBarVisible: false,</div><div class="line">      tabBarLabel: &apos;我的&apos;,</div><div class="line">      tabBarIcon: (&#123;tintColor&#125;) =&gt;</div><div class="line">        &lt;Image</div><div class="line">          style=&#123;[styles.tabBarImage,]&#125;</div><div class="line">          source=&#123;require(&apos;../images/mode.png&apos;)&#125;</div><div class="line">        /&gt;,</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">const TabNavigatorConfig = &#123;</div><div class="line">  initialRouteName: &apos;Home&apos;,</div><div class="line">  animationEnabled: true,</div><div class="line">  tabBarPosition: &apos;bottom&apos;,</div><div class="line">  swipeEnabled: true,</div><div class="line">  backBehavior: &apos;none&apos;,</div><div class="line">  tabBarOptions: &#123;</div><div class="line">    activeTintColor: &apos;orange&apos;,</div><div class="line">    inactiveTintColor: &apos;gray&apos;,</div><div class="line">    inactiveBackgroundColor: &apos;#9eff5b&apos;,</div><div class="line">    activeBackgroundColor: &apos;#ffaeb5&apos;,</div><div class="line">    showIcon: true,</div><div class="line">    showLabel: true,</div><div class="line">    upperCaseLabel: false,</div><div class="line">    style: &#123;</div><div class="line">      backgroundColor: &apos;white&apos;,</div><div class="line">    &#125;,</div><div class="line">    tabStyle: &#123;</div><div class="line">      height: 56,</div><div class="line">    &#125;,</div><div class="line">    labelStyle: &#123;</div><div class="line">      fontSize: 12,</div><div class="line">      marginBottom: 8,</div><div class="line">      marginTop: 6,</div><div class="line">    &#125;,</div><div class="line">    iconStyle: &#123;</div><div class="line">      height: 32,</div><div class="line">    &#125;,</div><div class="line">    indicatorStyle: &#123;</div><div class="line">      height: 0,</div><div class="line">    &#125;,</div><div class="line">    pressColor: &apos;gray&apos;,</div><div class="line">    pressOpacity: 0.8,</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">&#125;;</div><div class="line">const Tabs = TabNavigator(NavigationRouteConfigMap, TabNavigatorConfig);</div></pre></td></tr></table></figure>
<h1 id="DrawerNavigator"><a href="#DrawerNavigator" class="headerlink" title="DrawerNavigator"></a>DrawerNavigator</h1><p>这个导航是个抽屉效果</p>
<h4 id="函数原型-1"><a href="#函数原型-1" class="headerlink" title="函数原型:"></a>函数原型:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">const DrawerNavigator = (</div><div class="line">  routeConfigs: NavigationRouteConfigMap,</div><div class="line">  config: DrawerNavigatorConfig</div><div class="line">) =&gt; &#123;</div></pre></td></tr></table></figure>
<p>routeConfigs和StackNavigator，TabNavigator中的第一个参数一样。</p>
<h4 id="定义属性的相关源码：-2"><a href="#定义属性的相关源码：-2" class="headerlink" title="定义属性的相关源码："></a>定义属性的相关源码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">//DrawerNavigatorConfig的所有属性</div><div class="line">export type NavigationTabRouterConfig = &#123;</div><div class="line">  initialRouteName?: string,</div><div class="line">  paths?: NavigationPathsConfig,</div><div class="line">  navigationOptions?: NavigationScreenConfig&lt;NavigationTabScreenOptions&gt;,</div><div class="line">  order?: Array&lt;string&gt;, // todo: type these as the real route names rather than &apos;string&apos;</div><div class="line">  // Does the back button cause the router to switch to the initial tab</div><div class="line">  backBehavior?: &apos;none&apos; | &apos;initialRoute&apos;, // defaults `initialRoute`</div><div class="line">&#125;;</div><div class="line"></div><div class="line">export type DrawerViewConfig = &#123;</div><div class="line">  drawerWidth: number,</div><div class="line">  drawerPosition: &apos;left&apos; | &apos;right&apos;,</div><div class="line">  contentComponent: ReactClass&lt;*&gt;,</div><div class="line">  contentOptions?: &#123;&#125;,</div><div class="line">  style?: Style,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//navigationOptions的属性与TabNavigator一样</div><div class="line"></div><div class="line">//contentOptions的属性</div><div class="line">type Props = &#123;</div><div class="line">  navigation: NavigationScreenProp&lt;NavigationState, NavigationAction&gt;,</div><div class="line">  items: Array&lt;NavigationRoute&gt;,</div><div class="line">  activeItemKey?: string,</div><div class="line">  activeTintColor?: string,</div><div class="line">  activeBackgroundColor?: string,</div><div class="line">  inactiveTintColor?: string,</div><div class="line">  inactiveBackgroundColor?: string,</div><div class="line">  getLabel: (scene: DrawerScene) =&gt; ?(React.Element&lt;*&gt; | string),</div><div class="line">  renderIcon: (scene: DrawerScene) =&gt; ?React.Element&lt;*&gt;,</div><div class="line">  onItemPress: (info: DrawerItem) =&gt; void,</div><div class="line">  style?: Style,</div><div class="line">  labelStyle?: Style,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="属性总结：-1"><a href="#属性总结：-1" class="headerlink" title="属性总结："></a>属性总结：</h4><ul>
<li>initialRouteName:</li>
<li>paths:</li>
<li>navigationOptions:</li>
<li>order:</li>
<li>backBehavior:<blockquote>
<p>以上几个属性与TabNavigator一样</p>
</blockquote>
</li>
<li>drawerWidth:<blockquote>
<p>抽屉的宽度</p>
</blockquote>
</li>
<li>drawerPosition:<blockquote>
<p>枚举值可以为‘left’或’rigt’表示抽屉是在左边还是右边</p>
</blockquote>
</li>
<li>contentComponent:<blockquote>
<p>可以自定义显示drawer item的组件，默认是实现是DrawerItem</p>
</blockquote>
</li>
<li>contentOptions:<blockquote>
<p>drawer 内容的一些设置，背景颜色，tint颜色等等，下文将介绍contentOptions的属性</p>
</blockquote>
</li>
<li>style:</li>
</ul>
<p><strong>contentOptions属性</strong></p>
<ul>
<li>items:<blockquote>
<p>路由的数组</p>
</blockquote>
</li>
<li>activeItemKey:<blockquote>
<p>正在活动的路由的key</p>
</blockquote>
</li>
<li>activeTintColor:<blockquote>
<p>正在活动的 item tint 颜色</p>
</blockquote>
</li>
<li>activeBackgroundColor:<blockquote>
<p>正在活动的item的 背景颜色</p>
</blockquote>
</li>
<li>inactiveTintColor:<blockquote>
<p>不在活动的item的 tint颜色</p>
</blockquote>
</li>
<li>inactiveBackgroundColor:<blockquote>
<p>不在活动的item 的背景颜色</p>
</blockquote>
</li>
<li>getLabel: (scene: DrawerScene) =&gt; ?(React.Element&lt;*&gt; | string),</li>
<li>renderIcon: (scene: DrawerScene) =&gt; ?React.Element&lt;*&gt;,</li>
<li>onItemPress: (info: DrawerItem) =&gt; void,<blockquote>
<p>Item被按下时的回调</p>
</blockquote>
</li>
<li>style:</li>
<li>labelStyle:</li>
</ul>
<p><strong>navigationOptions属性</strong></p>
<blockquote>
<p>navigationOptions属性与TabNavigator一样</p>
</blockquote>
<h4 id="使用例子：-2"><a href="#使用例子：-2" class="headerlink" title="使用例子："></a>使用例子：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">const Drawer = DrawerNavigator(</div><div class="line">  //NavigationRouteConfigMap</div><div class="line">  &#123;</div><div class="line">    Main: &#123;</div><div class="line">      screen: Tabs,</div><div class="line">      navigationOptions: &#123;</div><div class="line">        drawerLabel: &apos;Main&apos;,</div><div class="line">        drawerIcon: (&#123;tintColor, focused&#125;) =&gt; (</div><div class="line">          &lt;Ionicons</div><div class="line">            name=&#123;focused ? &apos;ios-home&apos; : &apos;ios-home-outline&apos;&#125;</div><div class="line">            size=&#123;26&#125;</div><div class="line">            style=&#123;&#123;color: tintColor&#125;&#125;</div><div class="line">          /&gt;</div><div class="line">        ),</div><div class="line">      &#125;,</div><div class="line">    &#125;,</div><div class="line">    Profile: &#123;</div><div class="line">      screen: ProfileScreen,</div><div class="line">      navigationOptions: &#123;</div><div class="line">        drawerLabel: &apos;Profile&apos;,</div><div class="line">        drawerIcon: (&#123;tintColor, focused&#125;) =&gt; (</div><div class="line">          &lt;Ionicons</div><div class="line">            name=&#123;focused ? &apos;ios-person&apos; : &apos;ios-person-outline&apos;&#125;</div><div class="line">            size=&#123;26&#125;</div><div class="line">            style=&#123;&#123;color: tintColor&#125;&#125;</div><div class="line">          /&gt;</div><div class="line">        ),</div><div class="line">      &#125;,</div><div class="line">    &#125;,</div><div class="line">  &#125;,</div><div class="line">  //DrawerNavigatorConfig</div><div class="line">  &#123;</div><div class="line">    initialRouteName: &quot;Main&quot;,</div><div class="line">    drawerWidth: 200,</div><div class="line">    contentOptions:&#123;</div><div class="line">      activeTintColor:&quot;#7dd2ff&quot;,</div><div class="line">      activeBackgroundColor:&quot;#ffc31b&quot;,</div><div class="line">      style:&#123;backgroundColor: &quot;#6d1025&quot;&#125;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
<h1 id="navigation"><a href="#navigation" class="headerlink" title="navigation"></a>navigation</h1><p>使用ReactNavigation的应用中的每一个屏幕都有navigation和screenProps属性. navigation又有5个参数:<strong>navigate</strong>, <strong>goBack</strong>, <strong>state</strong>, <strong>setParams</strong>, <strong>dispatch</strong>。<br>如果想从外部给屏幕组件传入扩展的属性，可以使用<strong>screenProps</strong>，可以在组件下console.log一下this.props就能看到.</p>
<ul>
<li>this.props.navigation.navigate(‘Two’, { name: ‘two’ }): push下一个页面</li>
</ul>
<blockquote>
<p>routeName: 注册过的目标路由名称<br>params: 传递的参数<br>action: 如果该界面是一个navigator的话，将运行这个sub-action</p>
<ul>
<li>this.props.navigation.goBack(): 返回上一页</li>
</ul>
</blockquote>
<ul>
<li>this.props.navigation.state: 每个界面通过这去访问它的router，state其中包括了：</li>
</ul>
<blockquote>
<p>routeName: 路由名<br>key: 路由身份标识<br>params: 参数</p>
</blockquote>
<ul>
<li><p>this.props.navigation.setParams: 该方法允许界面更改router中的参数，可以用来动态的更改导航栏的内容</p>
</li>
<li><p>this.props.navigation.dispatch: 可以dispatch一些action，主要支持的<strong>action</strong>有：</p>
<h6 id="1-navigate"><a href="#1-navigate" class="headerlink" title="1. navigate"></a>1. navigate</h6></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import &#123; NavigationActions &#125; from &apos;react-navigation&apos;</div><div class="line"></div><div class="line">  const navigationAction = NavigationActions.navigate(&#123;</div><div class="line">    routeName: &apos;Profile&apos;,</div><div class="line">    params: &#123;&#125;,</div><div class="line"></div><div class="line">    // navigate can have a nested navigate action that will be run inside the child router</div><div class="line">    action: NavigationActions.navigate(&#123; routeName: &apos;SubProfileRoute&apos;&#125;)</div><div class="line">  &#125;)</div><div class="line">  this.props.navigation.dispatch(navigationAction)。</div></pre></td></tr></table></figure>
<h6 id="2-reset"><a href="#2-reset" class="headerlink" title="2. reset"></a>2. reset</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import &#123; NavigationActions &#125; from &apos;react-navigation&apos;</div><div class="line"></div><div class="line">  const resetAction = NavigationActions.reset(&#123;</div><div class="line">    index: 0,</div><div class="line">    actions: [</div><div class="line">      NavigationActions.navigate(&#123; routeName: &apos;Profile&apos;&#125;),</div><div class="line">      NavigationActions.navigate(&#123; routeName: &apos;Two&apos;&#125;)</div><div class="line">    ]</div><div class="line">  &#125;)</div><div class="line">  this.props.navigation.dispatch(resetAction)</div></pre></td></tr></table></figure>
<h6 id="3-setParams"><a href="#3-setParams" class="headerlink" title="3. setParams"></a>3. setParams</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">import &#123; NavigationActions &#125; from &apos;react-navigation&apos;</div><div class="line"></div><div class="line">  const setParamsAction = NavigationActions.setParams(&#123;</div><div class="line">    params: &#123;&#125;, // these are the new params that will be merged into the existing route params</div><div class="line">    // The key of the route that should get the new params</div><div class="line">    key: &apos;screen-123&apos;,</div><div class="line">  &#125;)</div><div class="line">  this.props.navigation.dispatch(setParamsAction)</div></pre></td></tr></table></figure>
<h6 id="4-back"><a href="#4-back" class="headerlink" title="4. back"></a>4. back</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">import &#123; NavigationActions &#125; from &apos;react-navigation&apos;</div><div class="line"></div><div class="line">const backAction = NavigationActions.back(&#123;</div><div class="line">  key: &apos;Profile&apos;</div><div class="line">&#125;)</div><div class="line">this.props.navigation.dispatch(backAction)</div></pre></td></tr></table></figure>
<h1 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ yarn add react-navigation 或者 npm install --save react-navigation</div></pre></td></tr></table></figure>
<p><a href="https://reactnavigation.org/docs/" target="_blank" rel="external">官方文档</a></p>
<p><a href="http://blog.csdn.net/a992036795/article/details/73322782" target="_blank" rel="external">参考</a></p>
<p><a href="https://github.com/RN-TV/Redux" target="_blank" rel="external">Demo</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-Redux-for-ReactNative" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2017/11/02/Redux-for-ReactNative/" class="article-date">
      <time datetime="2017-11-02T08:37:44.000Z" itemprop="datePublished">2017-11-02</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2017/11/02/Redux-for-ReactNative/">Redux for ReactNative</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="基本理论"><a href="#基本理论" class="headerlink" title="基本理论"></a>基本理论</h1><h2 id="1-官网定义："><a href="#1-官网定义：" class="headerlink" title="1.官网定义："></a>1.官网定义：</h2><p>Redux 是 JavaScript 状态容器，提供可预测化的状态管理。可以让你构建一致化的应用，运行于不同的环境（客户端、服务器、原生应用），并且易于测试。不仅于此，它还提供 超爽的开发体验，Redux 除了和 React 一起用外，还支持其它界面库。</p>
<p>Redux就是一个state管理的库，它好比Android中的MVP架构一样，使得复杂的业务逻辑和视图状态变得简单、清晰。</p>
<h2 id="2-三个原则："><a href="#2-三个原则：" class="headerlink" title="2.三个原则："></a>2.三个原则：</h2><ul>
<li><strong>单一数据源</strong>：整个应用的state被储存在一棵 object tree 中，并且这个 object tree 只存在于唯一一个<strong>store</strong>。</li>
<li><strong>State 是只读的</strong>：惟一改变 state 的方法就是触发 <strong>action</strong>，action 是一个用于描述已发生事件的普通对象。</li>
<li><strong>使用纯函数来执行修改</strong>：在改变state tree时，用到action，同时也需要编写对应的<strong>reducers</strong>才能完成state改变操作。</li>
</ul>
<h2 id="3-Action-Reducers-Store的职责："><a href="#3-Action-Reducers-Store的职责：" class="headerlink" title="3.Action,Reducers,Store的职责："></a>3.Action,Reducers,Store的职责：</h2><h4 id="Action"><a href="#Action" class="headerlink" title="Action:"></a>Action:</h4><p>Action 是把数据从应用传到 store 的有效载荷。它是 store 数据的唯一来源。一般来说你会通过 store的dispatch() 将 action 传到 store。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dispatch(&#123;type: TYPES.FETCH_MOVE_LIST, move: data&#125;);</div></pre></td></tr></table></figure>
<p>Action 本质上是 JavaScript 普通对象。我们约定，action 内必须使用一个字符串类型的 type 字段来表示将要执行的动作。多数情况下，type 会被定义成字符串常量。当应用规模越来越大时，建议使用单独的模块或文件来存放 action。</p>
<p>Action一般由++action创建函数++生成，在 Redux 中的 action 创建函数只是简单的返回一个 action</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">export const addList = (data) =&gt; &#123;</div><div class="line">	return &#123;</div><div class="line">		type: TYPES.FETCH_MOVE_LIST,</div><div class="line">		data</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Action 创建函数可以根据自己的业务逻辑定义，也可以使用<a href="https://github.com/reduxactions/redux-actions" target="_blank" rel="external">redux-actions</a></p>
<p>store 里可以直接通过 store.dispatch() 调用 dispatch() 方法，但是实际项目中使用 <a href="https://github.com/reactjs/react-redux" target="_blank" rel="external">react-redux</a> 提供的 connect() 将Redux Store与容器组件相连接。bindActionCreators() 可以自动把多个 action 创建函数 绑定到 dispatch() 方法上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">export default connect(</div><div class="line">  state =&gt; (&#123;</div><div class="line">    moves: state.home.data,</div><div class="line">  &#125;),</div><div class="line">  dispatch =&gt; bindActionCreators(&#123;fetchListAction: fetchList&#125;, dispatch)</div><div class="line">)(Home);</div><div class="line">//触发Action</div><div class="line">this.props.fetchListAction();</div></pre></td></tr></table></figure>
<h4 id="Reducers"><a href="#Reducers" class="headerlink" title="Reducers:"></a>Reducers:</h4><p>Reducer 就是一个纯函数，接收旧的 state 和 action，返回新的 state。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">const initialState = &#123;</div><div class="line">  isFetch: false,</div><div class="line">  data: [],</div><div class="line">  status: null,</div><div class="line">&#125;;</div><div class="line">const defaultAction = &#123;&#125;;</div><div class="line"></div><div class="line">export default function getNewState(state = initialState, action = defaultAction) &#123;</div><div class="line">  switch (action.type) &#123;</div><div class="line">    case TYPES.FETCH_MOVE_LIST:</div><div class="line">      return Object.assign(&#123;&#125;, state, &#123;</div><div class="line">        isFetch: true,</div><div class="line">        data: action.move,</div><div class="line">        status: &apos;done&apos;</div><div class="line">      &#125;);</div><div class="line">    case TYPES.FETCH_FIND_LIST:</div><div class="line">      return &#123;</div><div class="line">        ...state,</div><div class="line">        isFetch: false,</div><div class="line">        data: [],</div><div class="line">        status: null</div><div class="line">      &#125;;</div><div class="line">    default:</div><div class="line">      return state;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在实际项目中我们应该把各个模块的action分开，这样每一个action都应该对应有一个reducer,最后，Redux 提供了 combineReducers()把各个reducer合成为rootReducer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">export default function getRootReducer() &#123;</div><div class="line">  return combineReducers(&#123;</div><div class="line">    home: HomeReducer,</div><div class="line">    nav: NavReducer,</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>combineReducers() 所做的只是生成一个函数，这个函数来调用你的一系列 reducer，每个 reducer 根据它们的 key 来筛选出 state 中的一部分数据并处理，然后这个生成的函数再将所有 reducer 的结果合并成一个大的对象。</p>
<h4 id="Store"><a href="#Store" class="headerlink" title="Store:"></a>Store:</h4><p>Store中负责Action和Reducer的交互，并记录Reducer处理的最新State</p>
<p>Store有一下职责：</p>
<ul>
<li>维持应用的 state；</li>
<li>提供 getState() 方法获取 state；</li>
<li>提供 dispatch(action) 方法更新 state；</li>
<li>通过 subscribe(listener) 注册监听器;</li>
<li>通过 subscribe(listener) 返回的函数注销监听器。</li>
</ul>
<p>我们用createStore()函数生成一个store</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">import thunk from &apos;redux-thunk&apos;;</div><div class="line">import &#123;createStore, applyMiddleware, compose &#125; from &apos;redux&apos;;</div><div class="line">import rootReducer from &apos;../reducers&apos;;</div><div class="line"></div><div class="line">const middleware = applyMiddleware(thunk);</div><div class="line">let store = createStore(rootReducer(), undefined, middleware);</div><div class="line"></div><div class="line">export default store;</div></pre></td></tr></table></figure>
<p>最后我们用<a href="https://github.com/reactjs/react-redux" target="_blank" rel="external">react-redux</a>提供的Provider包装整个视图结构。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">render() &#123;</div><div class="line">    return (</div><div class="line">      &lt;Provider store=&#123;store&#125;&gt;</div><div class="line">        &lt;AppNavigation/&gt;</div><div class="line">      &lt;/Provider&gt;</div><div class="line">    )</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>用户行为触发Action的分发；Reducer接收Action和旧的State，并根据行为类型进行相应的逻辑处理，并返回最新State；Store中负责Action和Reducer的交互，并记录Reducer处理的最新State。并且还可以应用中间件等；此时可利用<strong>react-redux</strong>将状态与视图绑定利用<strong>redux-actions</strong>生成action和reducer利用<strong>redux-promise</strong>或<strong>redux-thunk</strong>实现异步。</p>
<h2 id="4-redux状态管理的流程"><a href="#4-redux状态管理的流程" class="headerlink" title="4.redux状态管理的流程"></a>4.redux状态管理的流程</h2><p><img src="http://upload-images.jianshu.io/upload_images/5684685-626d8bd4e4f596fe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p>
<h1 id="源码简单分析"><a href="#源码简单分析" class="headerlink" title="源码简单分析"></a>源码简单分析</h1><p>首先分析视图绑定库<a href="https://github.com/reactjs/react-redux" target="_blank" rel="external">react-redux</a>的源码。react-redux提供Provider, createProvider, connectAdvanced, connect这四个api,重点分析Provider，connect。</p>
<h2 id="1-Provider"><a href="#1-Provider" class="headerlink" title="1.Provider"></a>1.Provider</h2><blockquote>
<p>Provider本质就是一个普通的Component</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">export function createProvider(storeKey = &apos;store&apos;, subKey) &#123;</div><div class="line">    //...</div><div class="line">    class Provider extends Component &#123;</div><div class="line">        getChildContext() &#123;</div><div class="line">          return &#123; [storeKey]: this[storeKey], [subscriptionKey]: null &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        constructor(props, context) &#123;</div><div class="line">          super(props, context)</div><div class="line">          this[storeKey] = props.store;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        render() &#123;</div><div class="line">          return Children.only(this.props.children)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    Provider.propTypes = &#123;</div><div class="line">        store: storeShape.isRequired,</div><div class="line">        children: PropTypes.element.isRequired,</div><div class="line">    &#125;</div><div class="line">    return Provider</div><div class="line">&#125;</div><div class="line"></div><div class="line">export default createProvider()</div></pre></td></tr></table></figure>
<p>Provider是createProvider()函数的返回值，就是一个普通Component。有两个属性：store，children<br>所以使用Provider形式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">render() &#123;</div><div class="line">    return (</div><div class="line">      &lt;Provider</div><div class="line">        store=&#123;store&#125;</div><div class="line">        children=&#123;&lt;AppNavigation/&gt;</div><div class="line">        &#125;/&gt;</div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">  //或者</div><div class="line">  </div><div class="line">render() &#123;</div><div class="line">    return (</div><div class="line">      &lt;Provider store=&#123;store&#125;&gt;</div><div class="line">        &lt;AppNavigation/&gt;</div><div class="line">      &lt;/Provider&gt;</div><div class="line">    )</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="2-connect"><a href="#2-connect" class="headerlink" title="2.connect"></a>2.connect</h2><blockquote>
<p>connect函数原型function connect(mapStateToProps,mapDispatchToProps,mergeProps,{})</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">export function createConnect(&#123;</div><div class="line">  connectHOC = connectAdvanced,</div><div class="line">  mapStateToPropsFactories = defaultMapStateToPropsFactories,</div><div class="line">  mapDispatchToPropsFactories = defaultMapDispatchToPropsFactories,</div><div class="line">  mergePropsFactories = defaultMergePropsFactories,</div><div class="line">  selectorFactory = defaultSelectorFactory</div><div class="line">&#125; = &#123;&#125;) &#123;</div><div class="line">  return function connect(</div><div class="line">    mapStateToProps,</div><div class="line">    mapDispatchToProps,</div><div class="line">    mergeProps,</div><div class="line">    &#123;</div><div class="line">      pure = true,</div><div class="line">      areStatesEqual = strictEqual,</div><div class="line">      areOwnPropsEqual = shallowEqual,</div><div class="line">      areStatePropsEqual = shallowEqual,</div><div class="line">      areMergedPropsEqual = shallowEqual,</div><div class="line">      ...extraOptions</div><div class="line">    &#125; = &#123;&#125;</div><div class="line">  ) &#123;</div><div class="line">  //...</div><div class="line">  return connectHOC()</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">export default createConnect()</div></pre></td></tr></table></figure>
<p>connect是createConnect()函数的返回值，connect也是一个函数，一共有四个参数：mapStateToProps，mapDispatchToProps，mergeProps，options。返回另一个函数：function wrapWithConnect(WrappedComponent) {}</p>
<h4 id="参数："><a href="#参数：" class="headerlink" title="参数："></a>参数：</h4><ul>
<li>[mapStateToProps(state, [ownProps]): stateProps] (Function): 如果定义该参数，组件将会监听 Redux store 的变化。任何时候，只要 Redux store 发生改变，mapStateToProps 函数就会被调用。该回调函数必须返回一个纯对象，这个对象会与组件的 props 合并。如果你省略了这个参数，你的组件将不会监听 Redux store。如果指定了该回调函数中的第二个参数 ownProps，则该参数的值为传递到组件的 props，而且只要组件接收到新的 props，mapStateToProps 也会被调用。</li>
<li>[mapDispatchToProps(dispatch, [ownProps]): dispatchProps] (Object or Function): 如果传递的是一个对象，那么每个定义在该对象的函数都将被当作 Redux action creator，而且这个对象会与 Redux store 绑定在一起，其中所定义的方法名将作为属性名，合并到组件的 props 中。如果传递的是一个函数，该函数将接收一个 dispatch 函数，然后由你来决定如何返回一个对象，这个对象通过 dispatch 函数与 action creator 以某种方式绑定在一起（提示：你也许会用到 Redux 的辅助函数 bindActionCreators()）。如果你省略这个 mapDispatchToProps 参数，默认情况下，dispatch 会注入到你的组件 props 中。如果指定了该回调函数中第二个参数 ownProps，该参数的值为传递到组件的 props，而且只要组件接收到新 props，mapDispatchToProps 也会被调用。</li>
<li>[mergeProps(stateProps, dispatchProps, ownProps): props] (Function): 如果指定了这个参数，mapStateToProps() 与 mapDispatchToProps() 的执行结果和组件自身的 props 将传入到这个回调函数中。该回调函数返回的对象将作为 props 传递到被包装的组件中。你也许可以用这个回调函数，根据组件的 props 来筛选部分的 state 数据，或者把 props 中的某个特定变量与 action creator 绑定在一起。如果你省略这个参数，默认情况下返回 Object.assign({}, ownProps, stateProps, dispatchProps) 的结果。</li>
<li><p>[options] (Object) 如果指定这个参数，可以定制 connector 的行为。</p>
<p>  <strong>1.</strong>[pure = true] (Boolean): 如果为 true，connector 将执行 shouldComponentUpdate 并且浅对比 mergeProps 的结果，避免不必要的更新，前提是当前组件是一个“纯”组件，它不依赖于任何的输入或 state 而只依赖于 props 和 Redux store 的 state。默认值为 true。</p>
<p>  <strong>2.</strong>[withRef = false] (Boolean): 如果为 true，connector 会保存一个对被包装组件实例的引用，该引用通过 getWrappedInstance() 方法获得。默认值为 false</p>
</li>
</ul>
<h4 id="返回值："><a href="#返回值：" class="headerlink" title="返回值："></a>返回值：</h4><p>从源码中可以看出connect函数最后执行了connectHOC()这个函数，connectHOC是connectAdvanced所赋的值，下面是connectAdvanced函数的源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">export default function connectAdvanced(</div><div class="line">  selectorFactory,</div><div class="line">  &#123;</div><div class="line">    getDisplayName = name =&gt; `ConnectAdvanced($&#123;name&#125;)`,</div><div class="line"></div><div class="line">    methodName = &apos;connectAdvanced&apos;,</div><div class="line"></div><div class="line">    renderCountProp = undefined,</div><div class="line"></div><div class="line">    shouldHandleStateChanges = true,</div><div class="line"></div><div class="line">    storeKey = &apos;store&apos;,</div><div class="line"></div><div class="line">    withRef = false,</div><div class="line">    </div><div class="line">    ...connectOptions</div><div class="line">  &#125; = &#123;&#125;</div><div class="line">) &#123;</div><div class="line">    //...</div><div class="line">     return function wrapWithConnect(WrappedComponent) &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从源码中可以看出最后返回了wrapWithConnect函数。那么wrapWithConnect函数就是connect最后的返回值。</p>
<p>下面继续看一下wrapWithConnect函数的源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">function wrapWithConnect(WrappedComponent) &#123;</div><div class="line">    //...</div><div class="line">     class Connect extends Component &#123;</div><div class="line">         //...</div><div class="line">     &#125;</div><div class="line">     //...</div><div class="line">     return hoistStatics(Connect, WrappedComponent)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从源码可以看出，wrapWithConnect函数有一个参数：WrappedComponent。这个参数其实就是一个Component，最后返回的是一个新的已与 Redux store 连接的Component。所以connect函数使用形式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">export default connect(</div><div class="line">  state =&gt; (&#123;</div><div class="line">    moves: state.home.data,</div><div class="line">  &#125;),</div><div class="line">  dispatch =&gt; bindActionCreators(&#123;fetchListAction: fetchList, fetchMore&#125;, dispatch),</div><div class="line">)(Home);</div><div class="line">//这里省略了第三参数，默认情况下返回 Object.assign(&#123;&#125;, ownProps, stateProps, dispatchProps) 的结果。</div></pre></td></tr></table></figure>
<blockquote>
<p>总结connect函数的功能：连接 React 组件与 Redux store。<br>连接操作不会改变原来的组件类，反而返回一个新的已与 Redux store 连接的组件类</p>
</blockquote>
<p><strong>下面分析Redux源码，Redux提供５个api方法：createStore,combineReducers,bindActionCreators,applyMiddleware,compose</strong></p>
<h2 id="3-createStore"><a href="#3-createStore" class="headerlink" title="3.createStore"></a>3.createStore</h2><blockquote>
<p>创建一个 Redux store 来以存放应用中所有的 state。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">export default function createStore(reducer, preloadedState, enhancer) &#123;</div><div class="line">    //...</div><div class="line">    function getState() &#123;</div><div class="line">    return currentState</div><div class="line">  &#125;</div><div class="line">   //...</div><div class="line">  function subscribe(listener) &#123;</div><div class="line">    //...</div><div class="line">  &#125;</div><div class="line">   //...</div><div class="line">  function dispatch(action) &#123;</div><div class="line">    //...</div><div class="line">    return action</div><div class="line">   &#125;</div><div class="line">   //...</div><div class="line">    function replaceReducer(nextReducer) &#123;</div><div class="line">    if (typeof nextReducer !== &apos;function&apos;) &#123;</div><div class="line">      throw new Error(&apos;Expected the nextReducer to be a function.&apos;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    currentReducer = nextReducer</div><div class="line">    dispatch(&#123; type: ActionTypes.INIT &#125;)</div><div class="line">  &#125;</div><div class="line">  //...</div><div class="line">  return &#123;</div><div class="line">    dispatch,</div><div class="line">    subscribe,</div><div class="line">    getState,</div><div class="line">    replaceReducer,</div><div class="line">    [$$observable]: observable</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从源码中可以看出createStore函数接收三个参数返回一个store对象。store对象又有５个方法： dispatch,subscribe,getState,replaceReducer,[$$observable]: observable</p>
<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><ul>
<li><p>reducer (Function): 接收两个参数，分别是当前的 state 树和要处理的 action，返回新的 state 树。</p>
</li>
<li><p>[initialState] (any): 初始时的 state。 如果你使用 combineReducers 创建 reducer，它必须是一个普通对象，与传入的 keys 保持同样的结构。否则，你可以自由传入任何 reducer 可理解的内容。</p>
</li>
<li><p>enhancer (Function): Store enhancer 是一个组合 store creator 的高阶函数，返回一个新的强化过的 store creator。这与 middleware 相似，它也允许你通过复合函数改变 store 接口。一般是applyMiddleware函数的返回值。</p>
</li>
</ul>
<h4 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h4><p>(Store对象): 保存了应用所有 state 的对象。改变 state 的惟一方法是 dispatch action。你也可以 subscribe 监听 state 的变化，然后更新 UI。</p>
<h2 id="4-Store的方法"><a href="#4-Store的方法" class="headerlink" title="4.Store的方法"></a>4.Store的方法</h2><h4 id="getState"><a href="#getState" class="headerlink" title="getState()"></a>getState()</h4><blockquote>
<p>返回应用当前的 state 树。<br>它与 store 的最后一个 reducer 返回值相同。</p>
</blockquote>
<p><strong>返回值</strong>：</p>
<p>(any): 应用当前的 state 树。</p>
<hr>
<h4 id="dispatch-action"><a href="#dispatch-action" class="headerlink" title="dispatch(action)"></a>dispatch(action)</h4><blockquote>
<p>分发 action。这是触发 state 变化的惟一途径。</p>
<p>会使用当前 getState() 的结果和传入的 action 以同步方式的调用 store 的 reduce 函数。返回值会被作为下一个 state。从现在开始，这就成为了 getState() 的返回值，同时变化监听器(change listener)会被触发。</p>
</blockquote>
<p><strong>参数：</strong></p>
<ol>
<li>action (Object†): 描述应用变化的普通对象。</li>
</ol>
<p><strong>返回值</strong>：</p>
<p>(Object): 要 dispatch 的 action。</p>
<hr>
<h4 id="subscribe-listener"><a href="#subscribe-listener" class="headerlink" title="subscribe(listener)"></a>subscribe(listener)</h4><blockquote>
<p>添加一个变化监听器。每当 dispatch action 的时候就会执行，state 树中的一部分可能已经变化。你可以在回调函数里调用 getState() 来拿到当前 state。</p>
<p>这是一个底层 API。多数情况下，你不会直接使用它，会使用一些 React（或其它库）的绑定。如果你想让回调函数执行的时候使用当前的 state，你可以 把 store 转换成一个 Observable 或者写一个定制的 observeStore 工具。</p>
<p>如果需要解绑这个变化监听器，执行 subscribe 返回的函数即可。</p>
</blockquote>
<p><strong>参数</strong>：</p>
<ol>
<li>listener (Function): 每当 dispatch action 的时候都会执行的回调。state 树中的一部分可能已经变化。你可以在回调函数里调用 getState() 来拿到当前 state。store 的 reducer 应该是纯函数，因此你可能需要对 state 树中的引用做深度比较来确定它的值是否有变化。</li>
</ol>
<p><strong>返回值</strong>：</p>
<p>(Function): 一个可以解绑变化监听器的函数</p>
<hr>
<h4 id="replaceReducer-nextReducer"><a href="#replaceReducer-nextReducer" class="headerlink" title="replaceReducer(nextReducer)"></a>replaceReducer(nextReducer)</h4><blockquote>
<p>替换 store 当前用来计算 state 的 reducer。</p>
<p>这是一个高级 API。只有在你需要实现代码分隔，而且需要立即加载一些 reducer 的时候才可能会用到它。在实现 Redux 热加载机制的时候也可能会用到。</p>
</blockquote>
<p><strong>参数</strong>：</p>
<ol>
<li>reducer (Function) store 会使用的下一个 reducer。</li>
</ol>
<hr>
<h2 id="5-applyMiddleware"><a href="#5-applyMiddleware" class="headerlink" title="5.applyMiddleware"></a>5.applyMiddleware</h2><blockquote>
<p>使用包含自定义功能的 middleware 来扩展 Redux 是一种推荐的方式。Middleware 可以让你包装 store 的 dispatch 方法来达到你想要的目的。同时， middleware 还拥有“可组合”这一关键特性。多个 middleware 可以被组合到一起使用，形成 middleware 链。其中，每个 middleware 都不需要关心链中它前后的 middleware 的任何信息。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">export default function applyMiddleware(...middlewares) &#123;</div><div class="line">  return (createStore) =&gt; (reducer, preloadedState, enhancer) =&gt; &#123;</div><div class="line">    const store = createStore(reducer, preloadedState, enhancer)</div><div class="line">    let dispatch = store.dispatch</div><div class="line">    let chain = []</div><div class="line"></div><div class="line">    const middlewareAPI = &#123;</div><div class="line">      getState: store.getState,</div><div class="line">      dispatch: (action) =&gt; dispatch(action)</div><div class="line">    &#125;</div><div class="line">    chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))</div><div class="line">    dispatch = compose(...chain)(store.dispatch)</div><div class="line"></div><div class="line">    return &#123;</div><div class="line">      ...store,</div><div class="line">      dispatch</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="参数-1"><a href="#参数-1" class="headerlink" title="参数"></a>参数</h4><ul>
<li>…middlewares (arguments): 遵循 Redux middleware API 的函数。每个 middleware 接受 Store 的 dispatch 和 getState 函数作为命名参数，并返回一个函数。该函数会被传入 被称为 next 的下一个 middleware 的 dispatch 方法，并返回一个接收 action 的新函数，这个函数可以直接调用 next(action)，或者在其他需要的时刻调用，甚至根本不去调用它。调用链中最后一个 middleware 会接受真实的 store 的 dispatch 方法作为 next 参数，并借此结束调用链。所以，middleware 的函数签名是 ({ getState, dispatch }) =&gt; next =&gt; action。</li>
</ul>
<h4 id="返回值-1"><a href="#返回值-1" class="headerlink" title="返回值"></a>返回值</h4><p>(Function) 一个应用了 middleware 后的 store enhancer。这个 store enhancer 就是一个函数，并且需要应用到 createStore。它会返回一个应用了 middleware 的新的 createStore。</p>
<h2 id="6-combineReducers"><a href="#6-combineReducers" class="headerlink" title="6.combineReducers"></a>6.combineReducers</h2><blockquote>
<p>随着应用变得复杂，需要对 reducer 函数 进行拆分，拆分后的每一块独立负责管理 state 的一部分。</p>
<p>combineReducers 辅助函数的作用是，把一个由多个不同 reducer 函数作为 value 的 object，合并成一个最终的 reducer 函数，然后就可以对这个 reducer 调用 createStore。</p>
<p>合并后的 reducer 可以调用各个子 reducer，并把它们的结果合并成一个 state 对象。state 对象的结构由传入的多个 reducer 的 key 决定。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">export default function combineReducers(reducers) &#123;</div><div class="line">  const reducerKeys = Object.keys(reducers)</div><div class="line">  const finalReducers = &#123;&#125;</div><div class="line">  for (let i = 0; i &lt; reducerKeys.length; i++) &#123;</div><div class="line">    const key = reducerKeys[i]</div><div class="line"></div><div class="line">    if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</div><div class="line">      if (typeof reducers[key] === &apos;undefined&apos;) &#123;</div><div class="line">        warning(`No reducer provided for key &quot;$&#123;key&#125;&quot;`)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (typeof reducers[key] === &apos;function&apos;) &#123;</div><div class="line">      finalReducers[key] = reducers[key]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  const finalReducerKeys = Object.keys(finalReducers)</div><div class="line"></div><div class="line">  let unexpectedKeyCache</div><div class="line">  if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</div><div class="line">    unexpectedKeyCache = &#123;&#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  let shapeAssertionError</div><div class="line">  try &#123;</div><div class="line">    assertReducerShape(finalReducers)</div><div class="line">  &#125; catch (e) &#123;</div><div class="line">    shapeAssertionError = e</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return function combination(state = &#123;&#125;, action) &#123;</div><div class="line">    //...</div><div class="line">    return hasChanged ? nextState : state  </div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>从源码看出combineReducers函数接收一个参数：reducers，返回一个函数。</p>
<h4 id="参数-2"><a href="#参数-2" class="headerlink" title="参数"></a>参数</h4><ul>
<li>reducers (Object): 一个对象，它的值（value） 对应不同的 reducer 函数，这些 reducer 函数后面会被合并成一个。</li>
</ul>
<h4 id="返回值-2"><a href="#返回值-2" class="headerlink" title="返回值"></a>返回值</h4><p>(Function)：一个调用 reducers 对象里所有 reducer 的 reducer，并且构造一个与 reducers 对象结构相同的 state 对象。</p>
<h2 id="7-bindActionCreators"><a href="#7-bindActionCreators" class="headerlink" title="7.bindActionCreators"></a>7.bindActionCreators</h2><blockquote>
<p>把 action creators 转成拥有同名 keys 的对象，但使用 dispatch 把每个 action creator 包围起来，这样可以直接调用它们。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">export default function bindActionCreators(actionCreators, dispatch) &#123;</div><div class="line">  if (typeof actionCreators === &apos;function&apos;) &#123;</div><div class="line">    return bindActionCreator(actionCreators, dispatch)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (typeof actionCreators !== &apos;object&apos; || actionCreators === null) &#123;</div><div class="line">    throw new Error(</div><div class="line">      `bindActionCreators expected an object or a function, instead received $&#123;actionCreators === null ? &apos;null&apos; : typeof actionCreators&#125;. ` +</div><div class="line">      `Did you write &quot;import ActionCreators from&quot; instead of &quot;import * as ActionCreators from&quot;?`</div><div class="line">    )</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  const keys = Object.keys(actionCreators)</div><div class="line">  const boundActionCreators = &#123;&#125;</div><div class="line">  for (let i = 0; i &lt; keys.length; i++) &#123;</div><div class="line">    const key = keys[i]</div><div class="line">    const actionCreator = actionCreators[key]</div><div class="line">    if (typeof actionCreator === &apos;function&apos;) &#123;</div><div class="line">      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return boundActionCreators</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="参数-3"><a href="#参数-3" class="headerlink" title="参数"></a>参数</h4><ul>
<li><p>actionCreators (Function or Object): 一个 action creator，或者键值是 action creators 的对象。</p>
</li>
<li><p>dispatch (Function): 一个 dispatch 函数，由 Store 实例提供。</p>
</li>
</ul>
<h4 id="返回值-3"><a href="#返回值-3" class="headerlink" title="返回值"></a>返回值</h4><p>(Function or Object): 一个与原对象类似的对象，只不过这个对象中的的每个函数值都可以直接 dispatch action。如果传入的是一个函数，返回的也是一个函数。</p>
<p><a href="https://github.com/RN-TV/Redux.git" target="_blank" rel="external">Demo</a></p>
<p><a href="http://redux.js.org/" target="_blank" rel="external">官方文档</a></p>
<p><a href="http://www.redux.org.cn/" target="_blank" rel="external">中文文档</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-React组件生命周期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2017/10/11/React组件生命周期/" class="article-date">
      <time datetime="2017-10-11T08:37:44.000Z" itemprop="datePublished">2017-10-11</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2017/10/11/React组件生命周期/">React组件生命周期</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h1><ul>
<li>在React中，组件只是一种状态机，整个UI的渲染可以算做是状态驱动的。你更新一个组件的状态，然后根据新的状态渲染UI，React会以一种最效率的方式来更新DOM</li>
<li>大多数组件只需要根据传入的props里面的数据进行渲染，props是在组件初始化之后就从父级组件带入到组件内部。我们无法在使用的过程中对组件的props进行修改。但是当需要对用户输入，时间的流逝，服务端请求作出反应时，需要用state来进行状态记录，state是实际上组件中使用的数据，它可以被修改</li>
<li>在React中，通过调用setState(data, callback)来告诉它数据变动了，这个方法将data合并进this.state，之后告诉组件状态变动了需要进行重新渲染，callback会在重新渲染完毕后被调用。注意setState()这个方法是异步的，同步的多个setState方法只会触发一次实际render</li>
</ul>
<h2 id="生命周期图："><a href="#生命周期图：" class="headerlink" title="生命周期图："></a>生命周期图：</h2><p><img src="http://upload-images.jianshu.io/upload_images/5684685-2a8f06ecbfb533a5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p>
<h2 id="生命周期回调函数："><a href="#生命周期回调函数：" class="headerlink" title="生命周期回调函数："></a>生命周期回调函数：</h2><p>组件在实例化之后就开始了它的生命周期过程。它的整个生命周期主要由以下几个部分组成</p>
<ul>
<li>getDefaultProps():在组件类创建的时候调用一次，然后返回值被缓存下来, 它返回的任何复杂对象用于设置默认的props, 并且这些将会在实例间共享，而不是每个实例拥有一份拷贝。注意只能在子组件或组件树上调用setProps。别调用this.setProps或者直接修改this.props。可以通PropTypes对props的类型进行验证。（现在已经被<strong>static propTypes</strong>替代）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">static propTypes = &#123;</div><div class="line">   title: PropTypes.string.isRequired,</div><div class="line">   color: ColorPropType,</div><div class="line">  &#125;;</div></pre></td></tr></table></figure>
<ul>
<li>getInitialState():在组件挂载之前调用一次。返回值将会作为 this.state的初始值。这个方法执行时已经可以访问组件的props。注意state是每个组件自带的，而props是所有实例共享的。（现在已经被<strong>构造方法</strong>替代）</li>
<li>componentWillMount():在组件创建，并初始化了状态之后，初始化渲染执行之前立刻调用，且只调用一次，这是渲染前最后修改state的机会。函数原型如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void componentWillMount()</div></pre></td></tr></table></figure>
<ul>
<li>render():render方法返回的结果并不是真正的DOM元素，而是一个虚拟的表现，类似于一个DOM tree的结构的对象。它是唯一一个必须的方法。在这个方法中，会检测this.props和this.state，返回一个单子级组件,当然也可以返回null或者false。render函数不应该修改state,操作DOM或者与浏览器交互</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void render()</div></pre></td></tr></table></figure>
<ul>
<li>componentDidMount():在初始化渲染执行之后立刻调用一次,在生命周期中的这个时间点，组件拥有一个DOM展现[即虚拟DOM构建完毕]，你可以通过this.getDOMNode()来获取相应DOM节点。当需要从组件获取真实DOM的节点，可以使用ref属性。注意在RN中，是先调用子组件的componentDidMount()，然后调用父组件的函数。这个函数之后，就进入了稳定运行状态，等待事件触发。函数原型如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void componentDidMount()</div></pre></td></tr></table></figure>
<ul>
<li>componentWillReceiveProps():用此函数可以作为react在props传入之后，render()渲染之前更新state的机会,新的props是传入的,老的props可以通过this.props来获取。注意在该函数中调用this.setState()将不会引起额外的二次渲染。函数原型如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">void componentWillReceiveProps(  </div><div class="line">  object nextProps</div><div class="line">)</div></pre></td></tr></table></figure>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">componentWillReceiveProps: function(nextProps) &#123;</div><div class="line">	this.setState(&#123;</div><div class="line">	    likesIncreasing: nextProps.likeCount &gt; this.props.likeCount</div><div class="line">	&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>shouldComponentUpdate():在接收到新的props或者state,将要渲染之前调用。如果shouldComponentUpdate返回false,则render()将不会执行,直到下一次state改变。(通过此函数可以提高性能)，默认返回true。函数原型如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">boolean shouldComponentUpdate(  </div><div class="line">  object nextProps, object nextState</div><div class="line">)</div></pre></td></tr></table></figure>
<ul>
<li>componentWillUpdate():和componentWillMount类似,在组件接收到了新的props或者state即将进行重新渲染前调用,注意你不能在该方法中使用this.setState()。如果需要更新state来响应某个prop的改变,请使用componentWillReceiveProps。紧接着这个函数，就会调用render()来更新界面了。函数原型如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">void componentWillUpdate(  </div><div class="line">  object nextProps, object nextState</div><div class="line">)</div></pre></td></tr></table></figure>
<ul>
<li>componentDidUpdate():和componentDidMount类似,使用该方法可以在组件更新之后操作DOM元素,因为到这里已经完成了属性和状态的更新了，此函数的输入参数变成了 prevProps 和 prevState。函数原型如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">void componentDidUpdate(  </div><div class="line">  object prevProps, object prevState</div><div class="line">)</div></pre></td></tr></table></figure>
<ul>
<li>componentWillUnmount():当组件从DOM中移除的时候立刻调用来完成所有的清理和销毁工作,在conponentDidMount中添加的任务都需要再该方法中撤销,如创建的定时器或事件监听器。函数原型如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void componentWillUnmount()</div></pre></td></tr></table></figure>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><table>
<thead>
<tr>
<th>生命周期</th>
<th>调用次数</th>
<th>能否使用 setSate()</th>
</tr>
</thead>
<tbody>
<tr>
<td>static propTypes</td>
<td>１　</td>
<td>否</td>
</tr>
<tr>
<td>构造函数</td>
<td>１</td>
<td>否</td>
</tr>
<tr>
<td>componentWillMount</td>
<td>１</td>
<td>是</td>
</tr>
<tr>
<td>render</td>
<td>&gt;=１</td>
<td>否</td>
</tr>
<tr>
<td>componentDidMount</td>
<td>１</td>
<td>是</td>
</tr>
<tr>
<td>componentWillReceiveProps</td>
<td>&gt;=0</td>
<td>　是</td>
</tr>
<tr>
<td>shouldComponentUpdate</td>
<td>&gt;=0</td>
<td>　否</td>
</tr>
<tr>
<td>componentWillUpdate</td>
<td>&gt;=0</td>
<td>　否</td>
</tr>
<tr>
<td>componentDidUpdate</td>
<td>&gt;=0</td>
<td>　否</td>
</tr>
<tr>
<td>componentWillUnmount</td>
<td>１</td>
<td>否</td>
</tr>
</tbody>
</table>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-Android嵌套RN页面" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2017/07/26/Android嵌套RN页面/" class="article-date">
      <time datetime="2017-07-26T12:37:44.000Z" itemprop="datePublished">2017-07-26</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2017/07/26/Android嵌套RN页面/">Android嵌套RN页面</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="引入ReactNative相关文件"><a href="#引入ReactNative相关文件" class="headerlink" title="引入ReactNative相关文件"></a>引入ReactNative相关文件</h1><h4 id="1-从一个现有的ReactNative项目拷贝如下文件到自己的工程目录"><a href="#1-从一个现有的ReactNative项目拷贝如下文件到自己的工程目录" class="headerlink" title="1.从一个现有的ReactNative项目拷贝如下文件到自己的工程目录:"></a>1.从一个现有的ReactNative项目拷贝如下文件到自己的工程目录:</h4><ul>
<li>package.json </li>
<li>index.js</li>
<li>yarn.lock </li>
<li>app.json </li>
<li>——tests—— </li>
<li>.babelrc </li>
<li>.buckconfig </li>
<li>.flowconfig </li>
<li>.gitaattributes </li>
<li>.watchmanconfig<blockquote>
<p>其中package.json文件为安装项目node环境必须文件，其他文件也建议引入。当然也可以自己新建package.json app.json index.js文件</p>
</blockquote>
</li>
</ul>
<h4 id="2-修改package-json-app-json-index-js-文件的相关配置为自己的工程信息"><a href="#2-修改package-json-app-json-index-js-文件的相关配置为自己的工程信息" class="headerlink" title="2.修改package.json app.json index.js 文件的相关配置为自己的工程信息"></a>2.修改package.json app.json index.js 文件的相关配置为自己的工程信息</h4><h4 id="3-安装工程node环境"><a href="#3-安装工程node环境" class="headerlink" title="3.安装工程node环境"></a>3.安装工程node环境</h4><p>在package.json文件所在目录执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ yarn install 或 npm install</div></pre></td></tr></table></figure>
<blockquote>
<p>执行完毕会在当前目录生成node_modules文件夹，前提是电脑已经安装了node和react-native环境</p>
</blockquote>
<h4 id="4-开始编写js代码"><a href="#4-开始编写js代码" class="headerlink" title="4.开始编写js代码"></a>4.开始编写js代码</h4><h1 id="编写Android端代码"><a href="#编写Android端代码" class="headerlink" title="编写Android端代码"></a>编写Android端代码</h1><h2 id="引入依赖："><a href="#引入依赖：" class="headerlink" title="引入依赖："></a>引入依赖：</h2><h4 id="1-工程根目录build-gradle"><a href="#1-工程根目录build-gradle" class="headerlink" title="1.工程根目录build.gradle:"></a>1.工程根目录build.gradle:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">        mavenLocal()</div><div class="line">        maven &#123;</div><div class="line">            // 这里是指定所依赖的 React Native 是来自从 npm 安装来的 /node_modules 目录，</div><div class="line">            // 因为 Maven 中央仓库里的 React Native 可能不是最新的。</div><div class="line">            url &quot;$rootDir/node_modules/react-native/android&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-主Moundle目录build-gradle"><a href="#2-主Moundle目录build-gradle" class="headerlink" title="2.主Moundle目录build.gradle:"></a>2.主Moundle目录build.gradle:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">//依赖</div><div class="line">compile &apos;com.facebook.react:react-native:+&apos;</div><div class="line"></div><div class="line">android&#123;</div><div class="line">    //...</div><div class="line">    defaultConfig&#123;</div><div class="line">        //ndk支持</div><div class="line">        ndk&#123;</div><div class="line">            abiFilters &apos;armeabi&apos;, &apos;x86&apos;, &apos;armeabi-v7a&apos;</div><div class="line">        &#125;</div><div class="line">        //...</div><div class="line">    &#125;</div><div class="line">    //</div><div class="line">    splits &#123;</div><div class="line">        abi &#123;</div><div class="line">            reset()</div><div class="line">            enable enableSeparateBuildPerCPUArchitecture</div><div class="line">            universalApk false  // If true, also generate a universal APK</div><div class="line">            include &quot;armeabi-v7a&quot;, &quot;x86&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="３-如果有依赖其他三方开源项目："><a href="#３-如果有依赖其他三方开源项目：" class="headerlink" title="３.如果有依赖其他三方开源项目："></a>３.如果有依赖其他三方开源项目：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//例子：</div><div class="line">//settings.gradle中</div><div class="line"></div><div class="line">include &apos;:react-native-sqlite-storage&apos;</div><div class="line">project(&apos;:react-native-sqlite-storage&apos;).projectDir = new File(rootProject.projectDir, &apos;../node_modules/react-native-sqlite-storage/src/android&apos;)</div><div class="line"></div><div class="line">//主Moundle目录build.gradle中</div><div class="line">compile project(&apos;:react-native-sqlite-storage&apos;)</div></pre></td></tr></table></figure>
<blockquote>
<p>默认情况执行react-native link会自动添加以上代码</p>
</blockquote>
<h2 id="修改代码"><a href="#修改代码" class="headerlink" title="修改代码"></a>修改代码</h2><h4 id="1-AndroidManifest-xml中添加权限并注册DevSettingsActivity"><a href="#1-AndroidManifest-xml中添加权限并注册DevSettingsActivity" class="headerlink" title="1. AndroidManifest.xml中添加权限并注册DevSettingsActivity"></a>1. AndroidManifest.xml中添加权限并注册DevSettingsActivity</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:name=&quot;android.permission.SYSTEM_ALERT_WINDOW&quot; /&gt;</div><div class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot; /&gt;</div><div class="line">&lt;application</div><div class="line">        android:name=&quot;.MyApplication&quot;</div><div class="line">        android:allowBackup=&quot;true&quot;</div><div class="line">        android:icon=&quot;@mipmap/ic_launcher&quot;</div><div class="line">        android:label=&quot;@string/app_name&quot;</div><div class="line">        android:supportsRtl=&quot;true&quot;</div><div class="line">        android:theme=&quot;@style/AppTheme&quot;&gt;</div><div class="line">          &lt;activity android:name=&quot;com.facebook.react.devsupport.DevSettingsActivity&quot; /&gt;</div><div class="line"> &lt;/application&gt;</div></pre></td></tr></table></figure>
<h4 id="2-创建容器Activity"><a href="#2-创建容器Activity" class="headerlink" title="2. 创建容器Activity"></a>2. 创建容器Activity</h4><p> 创建容器Activity有两种方案。一:继承ReactNative提供ReactActivity。二:继承Android原生Activity,然后自己实现ReactNative提供的DefaultHardwareBackBtnHandler, PermissionAwareActivity接口.</p>
<blockquote>
<p>建议使用第二种方式,这样可以实现预加载需求.</p>
</blockquote>
<h4 id="3-创建ReactRootView"><a href="#3-创建ReactRootView" class="headerlink" title="3. 创建ReactRootView"></a>3. 创建ReactRootView</h4><p>在容器Activity onCreate中创建ReactRootView，如果有做预加载，优先缓存中获取ReactRootView</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mReactRootView = new ReactRootView(this);</div><div class="line"></div><div class="line">setContentView(mReactRootView);</div></pre></td></tr></table></figure>
<h4 id="4-获得ReactInstanceManager"><a href="#4-获得ReactInstanceManager" class="headerlink" title="4. 获得ReactInstanceManager"></a>4. 获得ReactInstanceManager</h4><p>ReactInstanceManager可以自己构建，也可以从ReactNativeHost获取，建议从ReactNativeHost中获取</p>
<p>从ReactNativeHost中获取：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">((ReactApplication) getApplication()).getReactNativeHost().getReactInstanceManager();</div></pre></td></tr></table></figure></p>
<p>自己构建：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"> ReactInstanceManagerBuilder builder = ReactInstanceManager.builder()</div><div class="line">                .setApplication(getApplication())</div><div class="line">                .setJSMainModuleName(&quot;index.android&quot;)</div><div class="line">                .addPackage(new MainReactPackage())</div><div class="line">                .setUseDeveloperSupport(true)</div><div class="line">                .setInitialLifecycleState(LifecycleState.RESUMED);</div><div class="line"></div><div class="line">//        for (ReactPackage reactPackage : getPackages()) &#123;</div><div class="line">//            builder.addPackage(reactPackage);</div><div class="line">//        &#125;</div><div class="line"></div><div class="line">        String jsBundleFile = FileUtils.getJsBundleFile(getApplicationContext());</div><div class="line">        if (jsBundleFile != null) &#123;</div><div class="line">            builder.setJSBundleFile(jsBundleFile);</div><div class="line">        &#125; else &#123;</div><div class="line">            builder.setBundleAssetName(Assertions.assertNotNull(&quot;index.android.bundle&quot;));</div><div class="line">        &#125;</div><div class="line">        mReactInstanceManager = builder.build();</div></pre></td></tr></table></figure></p>
<h4 id="5-生命周期函数回调ReactInstanceManager对应的方法。"><a href="#5-生命周期函数回调ReactInstanceManager对应的方法。" class="headerlink" title="5. 生命周期函数回调ReactInstanceManager对应的方法。"></a>5. 生命周期函数回调ReactInstanceManager对应的方法。</h4><h4 id="6-关联react-native项目。"><a href="#6-关联react-native项目。" class="headerlink" title="6. 关联react native项目。"></a>6. 关联react native项目。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mReactRootView.startReactApplication(mReactInstanceManager, &quot;RN&quot;, null);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意第二个参数与AppRegistry.registerComponent第一个参数一样。</p>
</blockquote>
<h4 id="7-打包js"><a href="#7-打包js" class="headerlink" title="7. 打包js"></a>7. 打包js</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">react-native bundle --platform android --dev false --entry-file index.android.js --bundle-output app/src/main/assets/index.android.bundle --assets-dest app/src/main/res/</div></pre></td></tr></table></figure>
<ul>
<li>（1）–entry   入口js文件，android系统就是index.android.js，ios系统就是index.ios.js</li>
<li>（2）–bundle-output   生成的bundle文件路径</li>
<li>（3）–platform   平台</li>
<li>（4）–assets-dest  图片资源的输出目录</li>
<li>（5）–dev   是否为开发版本，打正式版的安装包时我们将其赋值为false</li>
</ul>
<p><a href="https://github.com/RN-TV/Native" target="_blank" rel="external">Demo</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-Annotation" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2017/01/17/Annotation/" class="article-date">
      <time datetime="2017-01-17T08:37:44.000Z" itemprop="datePublished">2017-01-17</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2017/01/17/Annotation/">Java注解</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Java-注解"><a href="#Java-注解" class="headerlink" title="Java 注解"></a>Java 注解</h1><h2 id="元注解："><a href="#元注解：" class="headerlink" title="元注解："></a>元注解：</h2><p>元注解的作用就是负责注解其他注解。Java5.0定义了4个标准的meta-annotation类型，它们被用来提供对其它 annotation类型作说明。Java5.0定义的元注解：</p>
<ul>
<li>1.@Target</li>
<li>2.@Retention</li>
<li>3.@Documented</li>
<li>4.@Inherited</li>
</ul>
<p>这些类型和它们所支持的类在java.lang.annotation包中可以找到。下面我们看一下每个元注解的作用和相应分参数的使用说明。</p>
<h4 id="Target："><a href="#Target：" class="headerlink" title="@Target："></a>@Target：</h4><p>@Target说明了Annotation所修饰的对象范围：Annotation可被用于 packages、types（类、接口、枚举、Annotation类型）、类型成员（方法、构造方法、成员变量、枚举值）、方法参数和本地变量（如循环变量、catch参数）。在Annotation类型的声明中使用了target可更加明晰其修饰的目标。</p>
<p>作用：用于描述注解的使用范围（即：被描述的注解可以用在什么地方）</p>
<p>取值(ElementType)有：</p>
<ul>
<li>1.CONSTRUCTOR:用于描述构造器</li>
<li>2.FIELD:用于描述域</li>
<li>3.LOCAL_VARIABLE:用于描述局部变量</li>
<li>4.METHOD:用于描述方法</li>
<li>5.PACKAGE:用于描述包</li>
<li>6.PARAMETER:用于描述参数</li>
<li>7.TYPE:用于描述类、接口(包括注解类型) 或enum声明</li>
</ul>
<p>使用实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@Target(ElementType.TYPE)</div><div class="line">public @interface Table &#123;</div><div class="line">    /**</div><div class="line">     * 数据表名称注解，默认值为类名称</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public String tableName() default &quot;className&quot;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Target(ElementType.FIELD)</div><div class="line">public @interface NoDBColumn &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注解Table 可以用于注解类、接口(包括注解类型)或enum声明,而注解NoDBColumn仅可用于注解类的成员变量。</p>
<h3 id="Retention："><a href="#Retention：" class="headerlink" title="@Retention："></a>@Retention：</h3><p>@Retention定义了该Annotation被保留的时间长短：某些Annotation仅出现在源代码中，而被编译器丢弃；而另一些却被编译在class文件中；编译在class文件中的Annotation可能会被虚拟机忽略，而另一些在class被装载时将被读取（请注意并不影响class的执行，因为Annotation与class在使用上是被分离的）。使用这个meta-Annotation可以对 Annotation的“生命周期”限制。</p>
<p>作用：表示需要在什么级别保存该注释信息，用于描述注解的生命周期（即：被描述的注解在什么范围内有效）</p>
<p>取值（RetentionPoicy）有：</p>
<ul>
<li>1.SOURCE:在源文件中有效（即源文件保留）</li>
<li>2.CLASS:在class文件中有效（即class保留）</li>
<li>3.RUNTIME:在运行时有效（即运行时保留）</li>
</ul>
<p>Retention meta-annotation类型有唯一的value作为成员，它的取值来自java.lang.annotation.RetentionPolicy的枚举类型值。具体实例如下：<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@Target(ElementType.FIELD)</div><div class="line">@Retention(RetentionPolicy.RUNTIME)</div><div class="line">public @interface Column &#123;</div><div class="line">    public String name() default &quot;fieldName&quot;;</div><div class="line">    public String setFuncName() default &quot;setField&quot;;</div><div class="line">    public String getFuncName() default &quot;getField&quot;; </div><div class="line">    public boolean defaultDBValue() default false;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Column注解的的RetentionPolicy的属性值是RUTIME,这样注解处理器可以通过反射，获取到该注解的属性值，从而去做一些运行时的逻辑处理</p>
<h3 id="Documented"><a href="#Documented" class="headerlink" title="@Documented:"></a>@Documented:</h3><p>@Documented用于描述其它类型的annotation应该被作为被标注的程序成员的公共API，因此可以被例如javadoc此类的工具文档化。Documented是一个标记注解，没有成员。</p>
<p>具体实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@Target(ElementType.FIELD)</div><div class="line">@Retention(RetentionPolicy.RUNTIME)</div><div class="line">@Documented</div><div class="line">public @interface Column &#123;</div><div class="line">    public String name() default &quot;fieldName&quot;;</div><div class="line">    public String setFuncName() default &quot;setField&quot;;</div><div class="line">    public String getFuncName() default &quot;getField&quot;; </div><div class="line">    public boolean defaultDBValue() default false;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Inherited："><a href="#Inherited：" class="headerlink" title="@Inherited："></a>@Inherited：</h3><p>@Inherited 元注解是一个标记注解，@Inherited阐述了某个被标注的类型是被继承的。如果一个使用了@Inherited修饰的annotation类型被用于一个class，则这个annotation将被用于该class的子类。</p>
<p>注意：@Inherited annotation类型是被标注过的class的子类所继承。类并不从它所实现的接口继承annotation，方法并不从它所重载的方法继承annotation。</p>
<p>当@Inherited annotation类型标注的annotation的Retention是RetentionPolicy.RUNTIME，则反射API增强了这种继承性。如果我们使用java.lang.reflect去查询一个@Inherited annotation类型的annotation时，反射代码检查将展开工作：检查class和其父类，直到发现指定的annotation类型被发现，或者到达类继承结构的顶层。</p>
<p>实例代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * </div><div class="line"> * @author peida</div><div class="line"> *</div><div class="line"> */</div><div class="line">@Inherited</div><div class="line">public @interface Greeting &#123;</div><div class="line">    public enum FontColor&#123; BULE,RED,GREEN&#125;;</div><div class="line">    String name();</div><div class="line">    FontColor fontColor() default FontColor.GREEN;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="自定义注解："><a href="#自定义注解：" class="headerlink" title="自定义注解："></a>自定义注解：</h3><p>使用@interface自定义注解时，自动继承了java.lang.annotation.Annotation接口，由编译程序自动完成其他细节。在定义注解时，不能继承其他的注解或接口。@interface用来声明一个注解，其中的每一个方法实际上是声明了一个配置参数。方法的名称就是参数的名称，返回值类型就是参数的类型（返回值类型只能是基本类型、Class、String、enum）。可以通过default来声明参数的默认值。</p>
<p>定义注解格式：public @interface 注解名 {定义体}</p>
<p>注解参数的可支持数据类型：</p>
<ul>
<li>1.所有基本数据类型（int,float,boolean,byte,double,char,long,short)</li>
<li>2.String类型</li>
<li>3.Class类型</li>
<li>4.enum类型</li>
<li>5.Annotation类型</li>
<li>6.以上所有类型的数组</li>
</ul>
<p>Annotation类型里面的参数该怎么设定: </p>
<p>第一,只能用public或默认(default)这两个访问权修饰.例如,String value();这里把方法设为defaul默认类型；　 　</p>
<p>第二,参数成员只能用基本类型byte,short,char,int,long,float,double,boolean八种基本数据类型和 String,Enum,Class,annotations等数据类型,以及这一些类型的数组.例如,String value();这里的参数成员就为String;　　</p>
<p>第三,如果只有一个参数成员,最好把参数名称设为”value”,后加小括号.例:下面的例子FruitName注解就只有一个参数成员。</p>
<p>简单的自定义注解和使用注解实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">package annotation;</div><div class="line"></div><div class="line">import java.lang.annotation.Documented;</div><div class="line">import java.lang.annotation.ElementType;</div><div class="line">import java.lang.annotation.Retention;</div><div class="line">import java.lang.annotation.RetentionPolicy;</div><div class="line">import java.lang.annotation.Target;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 水果名称注解</div><div class="line"> * @author peida</div><div class="line"> *</div><div class="line"> */</div><div class="line">@Target(ElementType.FIELD)</div><div class="line">@Retention(RetentionPolicy.RUNTIME)</div><div class="line">@Documented</div><div class="line">public @interface FruitName &#123;</div><div class="line">    String value() default &quot;&quot;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-Handler" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2015/10/16/Handler/" class="article-date">
      <time datetime="2015-10-16T12:30:24.000Z" itemprop="datePublished">2015-10-16</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2015/10/16/Handler/">Handler机制</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Handler消息传递机制"><a href="#Handler消息传递机制" class="headerlink" title="Handler消息传递机制"></a>Handler消息传递机制</h1><p>Android的消息处理有四个核心类：Handler、Looper、Message、MessageQueue，都在android.os包中。</p>
<h2 id="一、线程的魔法师-Looper"><a href="#一、线程的魔法师-Looper" class="headerlink" title="一、线程的魔法师 Looper"></a>一、线程的魔法师 Looper</h2><p>Looper的字面意思是“循环器”,”轮询器”，它被设计用来使一个普通线程变成Looper线程。所谓Looper线程就是循环工作的线程。在程序开发中（尤其是GUI开发中），经常会需要一个线程不断循环，一旦有新任务则执行，执行完继续等待下一个任务，这就是Looper线程。使用Looper类创建Looper线程很简单，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public class LooperThread extends Thread &#123;</div><div class="line">    @Override</div><div class="line">    publicvoid run() &#123;</div><div class="line">// ①.将当前线程初始化为Looper线程</div><div class="line">        Looper.prepare();</div><div class="line">        public void handleMessage(Message msg) &#123;</div><div class="line">                super.handleMessage(msg);</div><div class="line">                switch (msg.what) &#123;</div><div class="line">                case 0:</div><div class="line">                    break;</div><div class="line">                default:</div><div class="line">                    break;</div><div class="line">            &#125;</div><div class="line">        &#125;      </div><div class="line">// ②.开始循环处理消息队列</div><div class="line">        Looper.loop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面两行核心代码，普通线程就升级为Looper线程了！！！看看这两行代码各自做了什么。</p>
<h3 id="1-Looper-prepare"><a href="#1-Looper-prepare" class="headerlink" title="(1)Looper.prepare()"></a>(1)Looper.prepare()</h3><p>现在你的线程中有一个Looper对象，它的内部维护了一个消息队列MQ。注意，一个Thread只能有一个Looper对象，为什么呢？咱们来看源码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class Looper &#123;</div><div class="line">    // 每个线程中的Looper对象其实是一个ThreadLocal，即线程本地存储(TLS)对象</div><div class="line">    privatestaticfinal ThreadLocal</div><div class="line">    sThreadLocal=new</div><div class="line"></div><div class="line">    ThreadLocal();</div><div class="line"></div><div class="line">    // Looper内的消息队列</div><div class="line">    final MessageQueue mQueue;</div><div class="line">    // 当前线程</div><div class="line">    Thread mThread;</div><div class="line">    // 。。。其他属性</div><div class="line"></div><div class="line">    // 每个Looper对象中有它的消息队列，和它所属的线程</div><div class="line">    private Looper() &#123;</div><div class="line">        mQueue = new MessageQueue();</div><div class="line">        mRun = true;</div><div class="line">        mThread = Thread.currentThread();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 我们调用该方法会在调用线程的TLS中创建Looper对象</div><div class="line">    publicstaticfinalvoid prepare() &#123;</div><div class="line">        if (sThreadLocal.get() != null) &#123;</div><div class="line">    // 试图在有Looper的线程中再次创建Looper将抛出异常</div><div class="line">            thrownew RuntimeException (&quot;Only one Looper may be created per thread&quot;);</div><div class="line">        &#125;</div><div class="line">        sThreadLocal.set(new Looper());</div><div class="line">    &#125;</div><div class="line">    // 其他方法</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过源码，prepare()背后的工作方式一目了然，其核心就是将looper对象定义为ThreadLocal,其实就是将一个唯一的Looper对象给添加到ThreadLocal中.</p>
<h3 id="2-Looper-loop"><a href="#2-Looper-loop" class="headerlink" title="(2)Looper.loop()"></a>(2)Looper.loop()</h3><p>调用loop方法后，Looper线程就开始真正工作了，它不断从自己的MQ中取出队头的消息(也叫任务)执行。其源码分析如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">public static final void loop() &#123;</div><div class="line">    Looper me = myLooper();  //得到当前线程Looper</div><div class="line">    MessageQueue queue = me.mQueue;  //得到当前looper的MQ</div><div class="line">    Binder.clearCallingIdentity();</div><div class="line">    finallong ident = Binder.clearCallingIdentity();</div><div class="line">    // 开始循环</div><div class="line">    while (true) &#123;</div><div class="line">        Message msg</div><div class="line">        Message msg = queue.next(); // 取出message</div><div class="line">        if (msg != null) &#123;</div><div class="line">            if (msg.target == null) &#123;</div><div class="line">                // message没有target为结束信号，退出循环</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        // 日志。。。</div><div class="line">        if (me.mLogging != null)</div><div class="line">            me.mLogging.println(&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot; + msg.target + &quot;&quot; + msg.callback</div><div class="line">                    + &quot;: &quot; + msg.what);</div><div class="line">        // 非常重要！将真正的处理工作交给message的target，即后面要讲的handler</div><div class="line">        msg.target.dispatchMessage(msg);</div><div class="line">        // 还是日志。。。</div><div class="line">        if (me.mLogging != null) me.mLogging.println(&quot;&lt;&lt;&lt;&lt;&lt; Finished to&quot; + msg.target + &quot; </div><div class="line">                &quot;+ msg.callback);     </div><div class="line">                finallong newIdent = Binder.clearCallingIdentity();</div><div class="line">        if (ident != newIdent) &#123;</div><div class="line">            Log.wtf(&quot;Looper&quot;, &quot;Thread identity changed from 0x&quot;</div><div class="line">                    + Long.toHexString(ident) + &quot; to 0x&quot;</div><div class="line">                    + Long.toHexString(newIdent) + &quot; while dispatching to &quot;</div><div class="line">                    + msg.target.getClass().getName() + &quot;&quot;</div><div class="line">                    + msg.callback + &quot; what=&quot; + msg.what);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    // 回收message资源</div><div class="line">    msg.recycle();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除了prepare()和loop()方法，Looper类还提供了一些有用的方法，比如:<br>Looper.myLooper()得到当前线程looper对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Looper.myLooper()得到当前线程looper对象：</div><div class="line">    public static final Looper myLooper()&#123;</div><div class="line">    // 在任意线程调用Looper.myLooper()返回的都是那个线程的looper</div><div class="line">    return (Looper)sThreadLocal.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getThread()得到looper对象所属线程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public Thread getThread() &#123;</div><div class="line">    return mThread;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>quit()方法结束looper循环:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">publicvoid quit() &#123;</div><div class="line">// 创建一个空的message，它的target为NULL，表示结束循环消息</div><div class="line">        Message msg = Message.obtain();</div><div class="line">// 发出消息</div><div class="line">        mQueue.enqueueMessage(msg, 0);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>到此为止，你应该对Looper有了基本的了解，总结几点：</p>
<ol>
<li>每个线程有且最多只能有一个Looper对象，它是一个ThreadLocal;</li>
<li>Looper内部有一个消息队列，loop()方法调用后线程开始不断从队列中取出消息执行;</li>
<li>Looper使一个线程变成Looper线程。<br>那么，我们如何往MQ上添加消息呢？下面有请Handler！<h2 id="二、异步处理大师-Handler"><a href="#二、异步处理大师-Handler" class="headerlink" title="二、异步处理大师 Handler"></a>二、异步处理大师 Handler</h2>什么是handler？handler扮演了往MQ上添加消息和处理消息的角色（只处理由自己发出的消息），即通知MQ它要执行一个任务(sendMessage)，并在loop到自己的时候执行该任务(handleMessage)，整个过程是异步的。handler创建时会关联一个looper，默认的构造方法将关联当前线程的looper。默认的构造方法：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class handler &#123;</div><div class="line"></div><div class="line">    final MessageQueue mQueue;  // 关联的MQ</div><div class="line">    final Looper mLooper;  // 关联的looper</div><div class="line">    final Callback mCallback;</div><div class="line">// 其他属性........</div><div class="line"></div><div class="line">    public Handler() &#123;</div><div class="line">        if (FIND_POTENTIAL_LEAKS) &#123;</div><div class="line">            final Class&lt;? extends Handler&gt; klass = getClass();</div><div class="line">            if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</div><div class="line">                    (klass.getModifiers() &amp; Modifier.STATIC) == 0) &#123;</div><div class="line">                Log.w(TAG, &quot;The following Handler class should be static or leaks might occur: &quot; +</div><div class="line">                        klass.getCanonicalName());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">// 默认将关联当前线程的looper</div><div class="line">        mLooper = Looper.myLooper();</div><div class="line">// looper不能为空，即该默认的构造方法只能在looper线程中使用</div><div class="line">        if (mLooper == null) &#123;</div><div class="line">            thrownew RuntimeException (</div><div class="line">                    &quot;Can&apos;t create handler inside thread that has not called Looper.prepare()&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">// 重要！！！直接把关联looper的MQ作为自己的MQ，因此它的消息将发送到关联looper的MQ上</div><div class="line">    mQueue=mLooper.mQueue;</div><div class="line">    mCallback=null;</div><div class="line">&#125;</div><div class="line">// 其他方法</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面我们就可以为之前的LooperThread类加入Handler：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public class LooperThread extends Thread &#123;</div><div class="line">    private Handler handler1;</div><div class="line">    private Handler handler2;</div><div class="line">    @Override</div><div class="line">    publi cvoid</div><div class="line"></div><div class="line">    run() &#123;</div><div class="line">// 将当前线程初始化为Looper线程</div><div class="line">        Looper.prepare();</div><div class="line">// 实例化两个handler</div><div class="line">        handler1 = new Handler();</div><div class="line">        handler2 = new Handler();</div><div class="line"></div><div class="line">// 开始循环处理消息队列</div><div class="line">        Looper.loop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，一个线程可以有多个Handler，但是只能有一个Looper！</p>
<hr>
<p>Handler发送消息<br>有了handler之后，我们就可以使用 </p>
<ul>
<li>post(Runnable), </li>
<li>postAtTime(Runnable, long),</li>
<li>postDelayed(Runnable, long),</li>
<li>sendEmptyMessage(int),</li>
<li>sendMessage(Message),</li>
<li>sendMessageAtTime(Message, long)和</li>
<li>sendMessageDelayed(Message, long).</li>
</ul>
<p>这些方法向MQ上发送消息了。光看这些API你可能会觉得handler能发两种消息，一种是Runnable对象，一种是message对象，这是直观的理解，但其实post发出的Runnable对象最后都被封装成message对象了，见源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"> // 此方法用于向关联的MQ上发送Runnable对象，它的run方法将在handler关联的looper线程中执行</div><div class="line">    public final boolean post(Runnable r) &#123;</div><div class="line">// 注意getPostMessage(r)将runnable封装成message</div><div class="line">        return sendMessageDelayed(getPostMessage(r), 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private final Message getPostMessage(Runnable r) &#123;</div><div class="line">        Message m = Message.obtain();  //得到空的message</div><div class="line">        m.callback = r;  //将runnable设为message的callback</div><div class="line">        return m;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public boolean sendMessageAtTime(Message msg, long uptimeMillis) &#123;</div><div class="line">        boolean sent = false;</div><div class="line">        MessageQueue queue = mQueue;</div><div class="line">        if (queue != null) &#123;</div><div class="line">            msg.target = this;  // message的target必须设为该handler！</div><div class="line">            sent = queue.enqueueMessage(msg, uptimeMillis);</div><div class="line">        &#125; else &#123;</div><div class="line">            RuntimeException e = new RuntimeException(</div><div class="line">                    this + &quot; sendMessageAtTime() called with no mQueue&quot;);</div><div class="line">            Log.w(&quot;Looper&quot;, e.getMessage(), e);</div><div class="line">        &#125;</div><div class="line">        return sent;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>总之通过handler发出的message有如下特点：</p>
<ol>
<li>message.target为该handler对象，这确保了looper执行到该message时能找到处理它的handler，即loop()方法中的关键代码msg.target.dispatchMessage(msg);</li>
<li>post发出的message，其callback为Runnable对象</li>
</ol>
<p>Handler处理消息<br>说完了消息的发送，再来看下handler如何处理消息。消息的处理是通过核心方法dispatchMessage(Message msg)与钩子方法handleMessage(Messagemsg)完成的，见源码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">// 处理消息，该方法由looper调用</div><div class="line">    public void dispatchMessage(Message msg) &#123;</div><div class="line">        if (msg.callback != null) &#123;</div><div class="line">// 如果message设置了callback，即runnable消息，处理callback！</div><div class="line">            handleCallback(msg);</div><div class="line">        &#125; else &#123;</div><div class="line">// 如果handler本身设置了callback，则执行callback</div><div class="line">            if (mCallback != null) &#123;</div><div class="line">/* 这种方法允许让activity等来实现Handler.Callback接口，避免了自己编写handler重写</div><div class="line">handleMessage方法。 */</div><div class="line">                if (mCallback.handleMessage(msg)) &#123;</div><div class="line">                    return;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">// 如果message没有callback，则调用handler的钩子方法handleMessage</div><div class="line">        handleMessage(msg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 处理runnable消息</div><div class="line">    private final void handleCallback(Message message) &#123;</div><div class="line">        message.callback.run();  //直接调用run方法！</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 由子类实现的钩子方法</div><div class="line">    public void handleMessage(Message msg) &#123;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到，除了handleMessage(Message msg)和Runnable对象的run方法由开发者实现外（实现具体逻辑），handler的内部工作机制对开发者是透明的。这正是handler API设计的精妙之处！</p>
<p>==Handler的用处==</p>
<p>handler被描述为“异步处理大师”，这归功于Handler拥有下面两个重要的特点：</p>
<ol>
<li>handler可以在任意线程发送消息，这些消息会被添加到关联的MQ上。</li>
<li>handler是在它关联的looper线程中处理消息的。 </li>
</ol>
<p>这就解决了android最经典的不能在其他非主线程中更新UI的问题。android的主线程也是一个looper线程(looper在android中运用很广)，我们在其中创建的handler默认将关联主线程MQ。因此，利用handler的一个solution就是在activity中创建handler并将其引用传递给worker thread，worker thread执行完任务后使用handler发送消息通知activity更新UI。</p>
<p>当然，handler能做的远远不仅如此，由于它能post Runnable对象，它还能与Looper配合实现经典的Pipeline Thread(流水线线程)模式。</p>
<h2 id="三、封装任务-Message"><a href="#三、封装任务-Message" class="headerlink" title="三、封装任务 Message"></a>三、封装任务 Message</h2><p>在整个消息处理机制中，message又叫task，封装了任务携带的信息和处理该任务的handler。message的用法比较简单，使用Message需要注意4点：</p>
<ol>
<li>Message虽然也可以通过new来获取，但是通常使用Message.obtain()或Handler.obtainMessage()方法来从消息池中获得空消息对象，以节省资源；</li>
<li>如果一个Message只需要携带简单的int型数据，应优先使用arg1和arg2属性来传递数据，这样比Bundle节省内存；</li>
<li>尽可能使用Message.what来标识信息，以便用不同的方式处理Message。</li>
<li>如果需要从工作线程返回很多数据信息，可以借助Bundle对象将这些数据集中到一起，然后存放到obj属性中，再返回到主线程。</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
    <article id="post-BroadcastReceiver" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2015/10/08/BroadcastReceiver/" class="article-date">
      <time datetime="2015-10-08T02:36:28.000Z" itemprop="datePublished">2015-10-08</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a  class="article-title" href="/2015/10/08/BroadcastReceiver/">BroadcastReceiver</a>
    </h1>
  


      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="一-广播简介："><a href="#一-广播简介：" class="headerlink" title="一.广播简介："></a>一.广播简介：</h1><h2 id="（一）、广播传播机制："><a href="#（一）、广播传播机制：" class="headerlink" title="（一）、广播传播机制："></a>（一）、广播传播机制：</h2><p>广播接收器，也被称为全局事件，或系统事件。</p>
<p>在Android中，有一些操作完成以后，会发送广播，比如说发出一条短信，或打出一个电话，如果某个程序接收了这个广播，就会做相应的处理。这个广播跟我们传统意义中的电台广播有些相似之处。之所以叫做广播，就是因为它只负责“说”而不管你“听不听”，也就是不管你接收方如何处理。另外，广播可以被不只一个应用程序所接收，当然也可能不被任何应用程序所接收。<br>广播机制最大的特点就是发送方并不关心接收方是否接到数据，也不关心接收方是如何处理数据的。<br>Android中广播的是操作系统中产生的各种各样的事件。例如，收到一条短信就会产生一个收到短信息的事件。而Android操作系统一旦内部产生了这些事件，就会向所有的广播接收器对象来广播这些事件。</p>
<h2 id="（二）、广播机制的三要素："><a href="#（二）、广播机制的三要素：" class="headerlink" title="（二）、广播机制的三要素："></a>（二）、广播机制的三要素：</h2><p>Android广播机制包含三个基本要素：<br>1、广播(Broadcast) - 用于发送广播；<br>2、广播接收器(BroadcastReceiver) - 用于接收广播；<br>3、意图内容(Intent)-用于保存广播相关信息的媒介。<br>Broadcast是一种广泛运用的在应用程序之间传输信息的机制。而BroadcastReceiver是对发送出来的Broadcast进行过滤接受并响应的一类组件。</p>
<h2 id="（三）、广播的生命周期："><a href="#（三）、广播的生命周期：" class="headerlink" title="（三）、广播的生命周期："></a>（三）、广播的生命周期：</h2><p>1、广播接收器仅在它执行这个方法时处于活跃状态。当onReceive()返回后，它即为失活状态。<br>2、拥有一个活跃状态的广播接收器的进程被保护起来而不会被杀死，但仅拥有失活状态组件的进程则会在其它进程需要它所占有的内存的时候随时被杀掉。<br>3、如果响应一个广播信息需要很长的一段时间，一般会将其纳入一个衍生的线程中去完成，而不是在主线程内完成它，从而保证用户交互过程的流畅。</p>
<h1 id="二、-广播接收器BroadcastReceiver："><a href="#二、-广播接收器BroadcastReceiver：" class="headerlink" title="二、 广播接收器BroadcastReceiver："></a>二、 广播接收器BroadcastReceiver：</h1><h2 id="（一）、概念："><a href="#（一）、概念：" class="headerlink" title="（一）、概念："></a>（一）、概念：</h2><p>BroadcastReceiver(广播接收器)是为了实现系统广播而提供的一种组件，并且广播事件处理机制是系统级别的。比如，我们可以发出一种广播来测试是否收到短信，这时候就可以定义一个BraodcastReceiver来接受广播，当收到短信时提示用户。我们既可以用Intent来启动一个组件，也可以用sendBroadcast()方法发起一个系统级别的事件广播来传递消息。<br>我们也可以在自己的应用程序中开发BroadcastReceiver，然后把广播接收器这个类或者对象注册到Android操作系统上去，让操作系统知道现在有这样一个广播接收器正在等待接收Android操作系统的广播，即在自己的应用程序中实现BroadcastReceiver来监听和响应广播的Intent。<br>当有广播事件产生时，Android操作系统首先告诉注册到其上面的广播接收器产生了一个怎么样的事件，每个接收器首先判断是不是我这个接收器需要的事件，如果是它所需要的事件，再进行相应的处理。<br>例子，我们把骚扰电话的黑名单放到数据库中去，当接到电话时会产生一个接电话事件，事先在Android操作系统中注册一个BroadcastReceiver的对象，当产生事件的时候，会通知我们的广播接收器对象，接收器对象接收到消息之后，就会到数据库里面去取所有黑名单电话和接到的这个电话号码进行比较，如果匹配就直接挂掉。</p>
<h2 id="（二）、-注册BroadcastReceiver的方法"><a href="#（二）、-注册BroadcastReceiver的方法" class="headerlink" title="（二）、 注册BroadcastReceiver的方法"></a>（二）、 注册BroadcastReceiver的方法</h2><p>BroadcastReceiver用于监听被广播的事件（Intent），为了达到这个目的，BroadcastReceiver必须进行注册，注册的方法有以下两种：</p>
<p>1、静态注册：<br>静态注册方式是在AndroidManifest.xml的application里面定义receiver并设置要接收的action。<br>静态注册方式的特点：不管该应用程序是否处于活动状态，都会进行监听。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;receiver </div><div class="line">    android:name=&quot;.CallReceiver&quot;</div><div class="line">    android:enabled=&quot;true&quot;&gt;</div><div class="line">    &lt;intent-filter &gt;</div><div class="line">        &lt;action android:name=&quot;android.intent.action.PHONE_STATE&quot;/&gt;</div><div class="line">    &lt;/intent-filter&gt;</div><div class="line">&lt;/receiver&gt;</div></pre></td></tr></table></figure>
<p>其中，MyReceiver为继承BroadcastReceiver的类，重写了onReceiver方法，并在onReceiver方法中对广播进行处理。<intent-filter>标签设置过滤器，接收指定action广播。</intent-filter></p>
<p>2、动态注册：<br>动态注册方式是在activity里面调用当前上下文对象的registerReceiver() 方法 来注册，和静态的内容差不多。一个形参是receiver对象，另一个是IntentFilter对象。而IntentFilter构造方法的参数是要接收的action。<br>动态注册方式特点：在代码中进行注册后，当应用程序关闭后，就不再进行监听。</p>
<p>MyReceiver receiver = new MyReceiver();<br>//创建过滤器，并指定action，使之用于接收同action的广播<br>IntentFilter filter = new IntentFilter(“android.intent.action.PHONE_STATE”);<br>//注册广播接收器<br>registerReceiver(receiver, filter);</p>
<h2 id="三-、广播接收器的优先级："><a href="#三-、广播接收器的优先级：" class="headerlink" title="( 三 )、广播接收器的优先级："></a>( 三 )、广播接收器的优先级：</h2><h2 id="四-、发送广播："><a href="#四-、发送广播：" class="headerlink" title="( 四 )、发送广播："></a>( 四 )、发送广播：</h2><p>// 指定广播目标Action<br>Intent intent = new Intent(“MyReceiver_Action”);<br>// 可通过Intent携带消息<br>intent.putExtra(“msg”, “发送广播”);<br>// 发送广播消息<br>sendBroadcast(intent);</p>
<h2 id="（五）、注销BroadcastReceiver："><a href="#（五）、注销BroadcastReceiver：" class="headerlink" title="（五）、注销BroadcastReceiver："></a>（五）、注销BroadcastReceiver：</h2><p>1、一般在onStart中注册BroadcastReceiver，在onStop中取消BroadcastReceiver。<br>2、一个BroadcastReceiver 对象只有在被调用onReceive(Context, Intent)时才有效，当从该函数返回后，该对象就无效的了，结束生命周期。</p>
<p>//注销广播接收器<br>unregisterReceiver(receiver);</p>
<h1 id="三、接收系统广播："><a href="#三、接收系统广播：" class="headerlink" title="三、接收系统广播："></a>三、接收系统广播：</h1><p>广播接收器最大的用途就是接受系统发出的消息。例如：截获短信，截获来电等等。</p>
<ol>
<li>（一）、短信拦截：</li>
<li>（二）、来去电拦截：</li>
<li>（三）、截获屏幕休眠与唤醒：</li>
<li>（四）、开机自动运行：</li>
<li>（五）、手机电池当前电量：</li>
</ol>
<h1 id="四-BroadcastReceiver所对应的广播分两类：普通广播和有序广播。"><a href="#四-BroadcastReceiver所对应的广播分两类：普通广播和有序广播。" class="headerlink" title="四.BroadcastReceiver所对应的广播分两类：普通广播和有序广播。"></a>四.BroadcastReceiver所对应的广播分两类：普通广播和有序广播。</h1><p>1、普通广播通过Context.sendBroadcast()方法来发送。它是完全异步的。<br>      所有的receivers接收器的执行顺序不确定。因此，所有的receivers接收器接收broadcast的顺序不确定。<br>     这种方式效率更高。但是BroadcastReceiver无法使用setResult系列，getResult系列及abort系列API。</p>
<p>2、有序广播是通过Context.sendOrderedBroadcast来发送。所有的receiver依次执行。<br>      BroadcastReceiver可以使用setResult系列函数来将结果传给下一个BroadcastReceiver，通过getResult系列函数来取得上个BroadcastReceiver返回的结果，并可以用abort系列函数来让系统丢弃该广播，使该广播不再传送到别的BroadcastReceiver。<br>      可以通过在intent-filter中设置android:priority属性来设置receiver的优先级。优先级相同的receiver其执行顺序不确定。<br>      如果BroadcastReceiver是代码中注册的话，且其intent-filter拥有相同android:priority属性的话，先注册的将先收到广播。<br>      有序广播，即从优先级别最高的广播接收器开始接收，接收完了如果没有丢弃，就下传给下一个次高优先级别的广播接收器进行处理，依次类推，直到最后。</p>
<p>3、实例</p>
<p>程序效果：点击按钮，两个Receiver接收同一条广播，在logcat中打印出数据（按照Receiver的优先顺序，Receiver2先，Receiver1后）  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">//1,Manifest.xml</div><div class="line"></div><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;  </div><div class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;  </div><div class="line">    	...  </div><div class="line">    	&lt;application  </div><div class="line">        	android:icon=&quot;@drawable/ic_launcher&quot;  </div><div class="line">        	android:label=&quot;@string/app_name&quot; &gt;  </div><div class="line">        	... </div><div class="line">        	&lt;receiver android:name=&quot;.MyReceiver1&quot;&gt;  </div><div class="line">            	&lt;intent-filter android:priority=&quot;200&quot;&gt;  </div><div class="line">                	&lt;action android:name=&quot;com.song.123&quot;/&gt;  </div><div class="line">            	&lt;/intent-filter&gt;  </div><div class="line">        	&lt;/receiver&gt;  </div><div class="line"></div><div class="line">        	&lt;receiver android:name=&quot;.MyReceiver2&quot;&gt;  </div><div class="line">            	&lt;intent-filter android:priority=&quot;1000&quot;&gt;  </div><div class="line">                	&lt;action android:name=&quot;com.song.123&quot;/&gt;  </div><div class="line">            	&lt;/intent-filter&gt;  </div><div class="line">        	&lt;/receiver&gt;  </div><div class="line">    	&lt;/application&gt;    </div><div class="line">&lt;/manifest&gt;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">//2,主Activity  </div><div class="line"></div><div class="line">public class C48_BroadcastActivity extends Activity &#123;  </div><div class="line">    	/** Called when the activity is first created. */  </div><div class="line">    	Button button;  </div><div class="line">    	@Override  </div><div class="line">    	public void onCreate(Bundle savedInstanceState) &#123;  </div><div class="line">        	super.onCreate(savedInstanceState);  </div><div class="line">        	setContentView(R.layout.main);  </div><div class="line">        	button=(Button)findViewById(R.id.button);  </div><div class="line">        	button.setOnClickListener(new OnClickListener() &#123;  </div><div class="line">              </div><div class="line">            	@Override  </div><div class="line">            	public void onClick(View v) &#123;            </div><div class="line">                	Intent intent=new Intent(&quot;com.song.123&quot;);  </div><div class="line">                	Bundle bundle=new Bundle();  </div><div class="line">                	bundle.putString(&quot;a&quot;, &quot;aaa&quot;);  </div><div class="line">                	intent.putExtras(bundle);  </div><div class="line">                	//有序广播  </div><div class="line">                	sendOrderedBroadcast(intent, null);  </div><div class="line">            	&#125;  </div><div class="line">        	&#125;);            </div><div class="line">    	&#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">//3,Receiver2</div><div class="line"></div><div class="line">public class MyReceiver2 extends BroadcastReceiver&#123;    </div><div class="line">    	@Override  </div><div class="line">    	public void onReceive(Context context, Intent intent) &#123;  </div><div class="line">        	System.out.println(&quot;receiver2&quot;);  </div><div class="line">//      context.getSystemService(name);  </div><div class="line">        	Bundle bundle=intent.getExtras();  </div><div class="line">        	bundle.putString(&quot;b&quot;, &quot;bbb&quot;);  </div><div class="line">        	System.out.println(&quot;a=&quot;+bundle.get(&quot;a&quot;));  </div><div class="line">        	setResultExtras(bundle);  </div><div class="line">        	//终止广播  </div><div class="line">//      abortBroadcast();  </div><div class="line">    	&#125;   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">//4,Receiver1</div><div class="line">public class MyReceiver1 extends BroadcastReceiver&#123;  </div><div class="line">  </div><div class="line">    	@Override  </div><div class="line">    	public void onReceive(Context context, Intent intent) &#123;  </div><div class="line">        </div><div class="line">        	System.out.println(&quot;receiver1&quot;);  </div><div class="line">        	//要不要接受上一个广播接收器receiver2传来的的数据  </div><div class="line">        	Bundle bundle=getResultExtras(true);  </div><div class="line">        	System.out.println(&quot;a=&quot;+bundle.getString(&quot;a&quot;)+&quot;,b=&quot;+bundle.getString(&quot;b&quot;));  </div><div class="line">    	&#125; </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<hr>
<p>//4,结果</p>
<p>receiver2<br>a=aaa<br>receiver1<br>a=aaa,b=bbb</p>
<h1 id="五、参考：【Android系统广播大全】"><a href="#五、参考：【Android系统广播大全】" class="headerlink" title="五、参考：【Android系统广播大全】"></a>五、参考：【Android系统广播大全】</h1><ul>
<li>String ADD_SHORTCUT_ACTION 动作：在系统中添加一个快捷方式。 </li>
<li>String ALL_APPS_ACTION 动作：列举所有可用的应用。输入：无。 </li>
<li>String ALTERNATIVE_CATEGORY 类别：说明 activity 是用户正在浏览的数据的一个可选操作。 </li>
<li>String ANSWER_ACTION 动作：处理拨入的电话。 </li>
<li>String BATTERY_CHANGED_ACTION 广播：充电状态，或者电池的电量发生变化。 </li>
<li>String BOOT_COMPLETED_ACTION 广播：在系统启动后，这个动作被广播一次（只有一次）。 </li>
<li>String BROWSABLE_CATEGORY 类别：能够被浏览器安全使用的 activities 必须支持这个类别。 </li>
<li>String BUG_REPORT_ACTION 动作：显示 activity 报告错误。 </li>
<li>String CALL_ACTION 动作：拨打电话，被呼叫的联系人在数据中指定。 </li>
<li>String CALL_FORWARDING_STATE_CHANGED_ACTION 广播：语音电话的呼叫转移状态已经改变。 </li>
<li>String CLEAR_CREDENTIALS_ACTION 动作：清除登陆凭证 (credential)。 </li>
<li>String CONFIGURATION_CHANGED_ACTION 广播：设备的配置信息已经改变，参见 Resources.Configuration.<br>Creator CREATOR 无 无 </li>
<li>String DATA_ACTIVITY_STATE_CHANGED_ACTION 广播：电话的数据活动(data activity)状态（即收发数据的状态）已经改变。 </li>
<li>String DATA_CONNECTION_STATE_CHANGED_ACTION 广播：电话的数据连接状态已经改变。 </li>
<li>String DATE_CHANGED_ACTION 广播：日期被改变。 </li>
<li>String DEFAULT_ACTION 动作：和 VIEW_ACTION 相同，是在数据上执行的标准动作。 </li>
<li>String DEFAULT_CATEGORY 类别：如果 activity 是对数据执行确省动作（点击, center press）的一个选项，需要设置这个类别。 </li>
<li>String DELETE_ACTION 动作：从容器中删除给定的数据。 </li>
<li>String DEVELOPMENT_PREFERENCE_CATEGORY 类别：说明 activity 是一个设置面板 (development preference panel). </li>
<li>String DIAL_ACTION 动作：拨打数据中指定的电话号码。 </li>
<li>String EDIT_ACTION 动作：为制定的数据显示可编辑界面。 </li>
<li>String EMBED_CATEGORY 类别：能够在上级（父）activity 中运行。 </li>
<li>String EMERGENCY_DIAL_ACTION 动作：拨打紧急电话号码。<br>int FORWARD_RESULT_LAUNCH 启动标记：如果这个标记被设置，而且被一个已经存在的 activity 用来启动新的 activity，已有 activity 的回复目标 (reply target) 会被转移给新的 activity。 </li>
<li>String FOTA_CANCEL_ACTION 广播：取消所有被挂起的 (pending) 更新下载。 </li>
<li>String FOTA_INSTALL_ACTION 广播：更新已经被确认，马上就要开始安装。 </li>
<li>String FOTA_READY_ACTION 广播：更新已经被下载，可以开始安装。 </li>
<li>String FOTA_RESTART_ACTION 广播：恢复已经停止的更新下载。 </li>
<li>String FOTA_UPDATE_ACTION 广播：通过 OTA 下载并安装操作系统更新。 </li>
<li>String FRAMEWORK_INSTRUMENTATION_TEST_CATEGORY 类别：To be used as code under test for framework instrumentation tests. </li>
<li>String GADGET_CATEGORY 类别：这个 activity 可以被嵌入宿主 activity (activity that is hosting gadgets)。 </li>
<li>String GET_CONTENT_ACTION 动作：让用户选择数据并返回。 </li>
<li>String HOME_CATEGORY 类别：主屏幕 (activity)，设备启动后显示的第一个 activity。 </li>
<li>String INSERT_ACTION 动作：在容器中插入一个空项 (item)。 </li>
<li>String INTENT_EXTRA 附加数据：和 PICK_ACTIVITY_ACTION 一起使用时，说明用户选择的用来显示的 activity；和 ADD_SHORTCUT_ACTION 一起使用的时候，描述要添加的快捷方式。 </li>
<li>String LABEL_EXTRA 附加数据：大写字母开头的字符标签，和 ADD_SHORTCUT_ACTION 一起使用。 </li>
<li>String LAUNCHER_CATEGORY 类别：Activity 应该被显示在顶级的 launcher 中。 </li>
<li>String LOGIN_ACTION 动作：获取登录凭证。 </li>
<li>String MAIN_ACTION 动作：作为主入口点启动，不需要数据。 </li>
<li>String MEDIABUTTON_ACTION 广播：用户按下了“Media Button”。 </li>
<li>String MEDIA_BAD_REMOVAL_ACTION 广播：扩展介质（扩展卡）已经从 SD 卡插槽拔出，但是挂载点 (mount point) 还没解除 (unmount)。 </li>
<li>String MEDIA_EJECT_ACTION 广播：用户想要移除扩展介质（拔掉扩展卡）。 </li>
<li>String MEDIA_MOUNTED_ACTION 广播：扩展介质被插入，而且已经被挂载。 </li>
<li>String MEDIA_REMOVED_ACTION 广播：扩展介质被移除。 </li>
<li>String MEDIA_SCANNER_FINISHED_ACTION 广播：已经扫描完介质的一个目录。 </li>
<li>String MEDIA_SCANNER_STARTED_ACTION 广播：开始扫描介质的一个目录。 </li>
<li>String MEDIA_SHARED_ACTION 广播：扩展介质的挂载被解除 (unmount)，因为它已经作为 USB 大容量存储被共享。 </li>
<li>String MEDIA_UNMOUNTED_ACTION 广播：扩展介质存在，但是还没有被挂载 (mount)。 </li>
<li>String MESSAGE_WAITING_STATE_CHANGED_ACTION 广播：电话的消息等待（语音邮件）状态已经改变。<br>int MULTIPLE_TASK_LAUNCH 启动标记：和 NEW_TASK_LAUNCH 联合使用，禁止将已有的任务改变为前景任务 (foreground)。 </li>
<li>String NETWORK_TICKLE_RECEIVED_ACTION 广播：设备收到了新的网络 “tickle” 通知。<br>int NEW_TASK_LAUNCH 启动标记：设置以后，activity 将成为历史堆栈中的第一个新任务（栈顶）。<br>int NO_HISTORY_LAUNCH 启动标记：设置以后，新的 activity 不会被保存在历史堆栈中。 </li>
<li>String PACKAGE_ADDED_ACTION 广播：设备上新安装了一个应用程序包。 </li>
<li>String PACKAGE_REMOVED_ACTION 广播：设备上删除了一个应用程序包。 </li>
<li>String PHONE_STATE_CHANGED_ACTION 广播：电话状态已经改变。 </li>
<li>String PICK_ACTION 动作：从数据中选择一个项目 (item)，将被选中的项目返回。 </li>
<li>String PICK_ACTIVITY_ACTION 动作：选择一个 activity，返回被选择的 activity 的类（名）。 </li>
<li>String PREFERENCE_CATEGORY 类别：activity是一个设置面板 (preference panel)。 </li>
<li>String PROVIDER_CHANGED_ACTION 广播：更新将要（真正）被安装。 </li>
<li>String PROVISIONING_CHECK_ACTION 广播：要求 polling of provisioning service 下载最新的设置。 </li>
<li>String RUN_ACTION 动作：运行数据（指定的应用），无论它（应用）是什么。 </li>
<li>String SAMPLE_CODE_CATEGORY 类别：To be used as an sample code example (not part of the normal user experience). </li>
<li>String SCREEN_OFF_ACTION 广播：屏幕被关闭。 </li>
<li>String SCREEN_ON_ACTION 广播：屏幕已经被打开。 </li>
<li>String SELECTED_ALTERNATIVE_CATEGORY 类别：对于被用户选中的数据，activity 是它的一个可选操作。 </li>
<li>String SENDTO_ACTION 动作：向 data 指定的接收者发送一个消息。 </li>
<li>String SERVICE_STATE_CHANGED_ACTION 广播：电话服务的状态已经改变。 </li>
<li>String SETTINGS_ACTION 动作：显示系统设置。输入：无。 </li>
<li>String SIGNAL_STRENGTH_CHANGED_ACTION 广播：电话的信号强度已经改变。<br>int SINGLE_TOP_LAUNCH 启动标记：设置以后，如果 activity 已经启动，而且位于历史堆栈的顶端，将不再启动（不重新启动） activity。 </li>
<li>String STATISTICS_REPORT_ACTION 广播：要求 receivers 报告自己的统计信息。 </li>
<li>String STATISTICS_STATE_CHANGED_ACTION 广播：统计信息服务的状态已经改变。 </li>
<li>String SYNC_ACTION 动作：执行数据同步。 </li>
<li>String TAB_CATEGORY 类别：这个 activity 应该在 TabActivity 中作为一个 tab 使用。 </li>
<li>String TEMPLATE_EXTRA 附加数据：新记录的初始化模板。 </li>
<li>String TEST_CATEGORY 类别：作为测试目的使用，不是正常的用户体验的一部分。 </li>
<li>String TIMEZONE_CHANGED_ACTION 广播：时区已经改变。 </li>
<li>String TIME_CHANGED_ACTION 广播：时间已经改变（重新设置）。 </li>
<li>String TIME_TICK_ACTION 广播：当前时间已经变化（正常的时间流逝）。 </li>
<li>String UMS_CONNECTED_ACTION 广播：设备进入 USB 大容量存储模式。 </li>
<li>String UMS_DISCONNECTED_ACTION 广播：设备从 USB 大容量存储模式退出。 </li>
<li>String UNIT_TEST_CATEGORY 类别：应该被用作单元测试（通过 test harness 运行）。 </li>
<li>String VIEW_ACTION 动作：向用户显示数据。 </li>
<li>String WALLPAPER_CATEGORY 类别：这个 activity 能过为设备设置墙纸。 </li>
<li>String WALLPAPER_CHANGED_ACTION 广播：系统的墙纸已经改变。 </li>
<li>String WALLPAPER_SETTINGS_ACTION 动作：显示选择墙纸的设置界面。输入：无。 </li>
<li>String WEB_SEARCH_ACTION 动作：执行 web 搜索。 </li>
<li>String XMPP_CONNECTED_ACTION 广播：XMPP 连接已经被建立。 </li>
<li>String XMPP_DISCONNECTED_ACTION 广播：XMPP 连接已经被断开。</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2017 Pu Ming
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo &nbsp;&nbsp;</a><a href="https://github.com/maochunguang" target="_blank">Blog</a> by tommy
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >极客到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 1;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'xxxxx', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?xxxxxx";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>



<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(
            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>